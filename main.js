/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var ra=Object.create;var Ft=Object.defineProperty;var ia=Object.getOwnPropertyDescriptor;var sa=Object.getOwnPropertyNames;var aa=Object.getPrototypeOf,oa=Object.prototype.hasOwnProperty;var Dn=(c,e)=>()=>(c&&(e=c(c=0)),e);var k=(c,e)=>()=>(e||c((e={exports:{}}).exports,e),e.exports),Pn=(c,e)=>{for(var n in e)Ft(c,n,{get:e[n],enumerable:!0})},jr=(c,e,n,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of sa(e))!oa.call(c,o)&&o!==n&&Ft(c,o,{get:()=>e[o],enumerable:!(i=ia(e,o))||i.enumerable});return c};var Kr=(c,e,n)=>(n=c!=null?ra(aa(c)):{},jr(e||!c||!c.__esModule?Ft(n,"default",{value:c,enumerable:!0}):n,c)),la=c=>jr(Ft({},"__esModule",{value:!0}),c);var K,m,Y=Dn(()=>{K=class{level=1;prefix;constructor(e="WeWe RSS"){this.prefix=e}setLevel(e){this.level=e}debug(...e){this.level<=0&&console.debug(`[${this.prefix}]`,...e)}info(...e){this.level<=1&&console.log(`[${this.prefix}]`,...e)}warn(...e){this.level<=2&&console.warn(`[${this.prefix}]`,...e)}error(...e){this.level<=3&&console.error(`[${this.prefix}]`,...e)}},m=new K});var Jr={};Pn(Jr,{CleanupArticlesModal:()=>Fn});var Ie,Fn,Zr=Dn(()=>{Ie=require("obsidian");Y();Fn=class extends Ie.Modal{logger;onConfirm;defaultDays;estimatedCount;inputValue;confirmButton;constructor(e,n,i=30,o=0){super(e),this.logger=new K("CleanupArticlesModal"),this.onConfirm=n,this.defaultDays=i,this.estimatedCount=o,this.inputValue=i}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("wewe-rss-cleanup-modal"),e.createEl("h2",{text:"Clean Up Old Articles"});let n=e.createEl("div",{cls:"wewe-rss-modal-instructions"});n.createEl("p",{text:"Delete articles older than a specified number of days from the database."}),n.createEl("p",{text:"Note: This only removes database records. Note files in your vault will be preserved.",cls:"mod-warning"}),new Ie.Setting(e).setName("Keep articles from last").setDesc("Articles published before this many days ago will be deleted").addText(p=>{p.setPlaceholder("30").setValue(String(this.defaultDays)).onChange(y=>{let S=parseInt(y);!isNaN(S)&&S>0&&S<=365?(this.inputValue=S,this.updatePreview(),this.validateInput()):this.validateInput()}),p.inputEl.type="number",p.inputEl.min="1",p.inputEl.max="365",p.inputEl.addEventListener("keypress",y=>{y.key==="Enter"&&(y.preventDefault(),this.handleConfirm())})}).addExtraButton(p=>{p.setIcon("calendar").setTooltip("Days").extraSettingsEl.createSpan({text:"days"})});let i=e.createEl("div",{cls:"wewe-rss-cleanup-preview"});i.createEl("p",{text:"\u{1F4CA} Preview:",cls:"wewe-rss-preview-title"});let o=i.createEl("p",{cls:"wewe-rss-preview-text"});o.innerHTML=this.getPreviewText();let s=e.createEl("div",{cls:"wewe-rss-validation-message"});s.style.display="none";let d=e.createEl("div",{cls:"wewe-rss-modal-buttons"});d.createEl("button",{text:"Cancel",cls:"wewe-rss-btn"}).addEventListener("click",()=>{this.close()}),this.confirmButton=d.createEl("button",{text:"Delete Articles",cls:"wewe-rss-btn mod-warning"}),this.confirmButton.addEventListener("click",()=>{this.handleConfirm()}),this.logger.debug("Cleanup modal opened",{defaultDays:this.defaultDays,estimatedCount:this.estimatedCount})}updatePreview(){let e=this.contentEl.querySelector(".wewe-rss-preview-text");e&&(e.innerHTML=this.getPreviewText())}getPreviewText(){return this.estimatedCount===0?'<span style="color: var(--text-muted)">No articles will be deleted</span>':this.estimatedCount===1?'<span style="color: var(--text-warning)">Approximately <strong>1 article</strong> will be deleted</span>':`<span style="color: var(--text-warning)">Approximately <strong>${this.estimatedCount} articles</strong> will be deleted</span>`}validateInput(){let e=this.contentEl.querySelector(".wewe-rss-validation-message");if(!e)return;this.inputValue>=1&&this.inputValue<=365?(e.setAttribute("style","display: none;"),this.confirmButton.disabled=!1):(e.textContent="Please enter a value between 1 and 365 days",e.setAttribute("style","display: block; color: var(--text-error);"),this.confirmButton.disabled=!0)}async handleConfirm(){if(this.inputValue<1||this.inputValue>365){new Ie.Notice("Please enter a valid retention period (1-365 days)");return}this.logger.info("User confirmed cleanup",{retentionDays:this.inputValue}),this.confirmButton.disabled=!0,this.confirmButton.textContent="Deleting...";try{await this.onConfirm(this.inputValue),this.close()}catch(e){this.logger.error("Cleanup failed:",e),new Ie.Notice(`Cleanup failed: ${e.message}`),this.confirmButton.disabled=!1,this.confirmButton.textContent="Delete Articles"}}onClose(){let{contentEl:e}=this;e.empty()}}});var ti=k((uo,ei)=>{ei.exports=function(){return typeof Promise=="function"&&Promise.prototype&&Promise.prototype.then}});var ve=k(De=>{var kn,ca=[0,26,44,70,100,134,172,196,242,292,346,404,466,532,581,655,733,815,901,991,1085,1156,1258,1364,1474,1588,1706,1828,1921,2051,2185,2323,2465,2611,2761,2876,3034,3196,3362,3532,3706];De.getSymbolSize=function(e){if(!e)throw new Error('"version" cannot be null or undefined');if(e<1||e>40)throw new Error('"version" should be in range from 1 to 40');return e*4+17};De.getSymbolTotalCodewords=function(e){return ca[e]};De.getBCHDigit=function(c){let e=0;for(;c!==0;)e++,c>>>=1;return e};De.setToSJISFunction=function(e){if(typeof e!="function")throw new Error('"toSJISFunc" is not a valid function.');kn=e};De.isKanjiModeEnabled=function(){return typeof kn<"u"};De.toSJIS=function(e){return kn(e)}});var kt=k(re=>{re.L={bit:1};re.M={bit:0};re.Q={bit:3};re.H={bit:2};function ua(c){if(typeof c!="string")throw new Error("Param is not a string");switch(c.toLowerCase()){case"l":case"low":return re.L;case"m":case"medium":return re.M;case"q":case"quartile":return re.Q;case"h":case"high":return re.H;default:throw new Error("Unknown EC Level: "+c)}}re.isValid=function(e){return e&&typeof e.bit<"u"&&e.bit>=0&&e.bit<4};re.from=function(e,n){if(re.isValid(e))return e;try{return ua(e)}catch{return n}}});var ii=k((po,ri)=>{function ni(){this.buffer=[],this.length=0}ni.prototype={get:function(c){let e=Math.floor(c/8);return(this.buffer[e]>>>7-c%8&1)===1},put:function(c,e){for(let n=0;n<e;n++)this.putBit((c>>>e-n-1&1)===1)},getLengthInBits:function(){return this.length},putBit:function(c){let e=Math.floor(this.length/8);this.buffer.length<=e&&this.buffer.push(0),c&&(this.buffer[e]|=128>>>this.length%8),this.length++}};ri.exports=ni});var ai=k((go,si)=>{function ot(c){if(!c||c<1)throw new Error("BitMatrix size must be defined and greater than 0");this.size=c,this.data=new Uint8Array(c*c),this.reservedBit=new Uint8Array(c*c)}ot.prototype.set=function(c,e,n,i){let o=c*this.size+e;this.data[o]=n,i&&(this.reservedBit[o]=!0)};ot.prototype.get=function(c,e){return this.data[c*this.size+e]};ot.prototype.xor=function(c,e,n){this.data[c*this.size+e]^=n};ot.prototype.isReserved=function(c,e){return this.reservedBit[c*this.size+e]};si.exports=ot});var oi=k(Mt=>{var da=ve().getSymbolSize;Mt.getRowColCoords=function(e){if(e===1)return[];let n=Math.floor(e/7)+2,i=da(e),o=i===145?26:Math.ceil((i-13)/(2*n-2))*2,s=[i-7];for(let d=1;d<n-1;d++)s[d]=s[d-1]-o;return s.push(6),s.reverse()};Mt.getPositions=function(e){let n=[],i=Mt.getRowColCoords(e),o=i.length;for(let s=0;s<o;s++)for(let d=0;d<o;d++)s===0&&d===0||s===0&&d===o-1||s===o-1&&d===0||n.push([i[s],i[d]]);return n}});var ui=k(ci=>{var fa=ve().getSymbolSize,li=7;ci.getPositions=function(e){let n=fa(e);return[[0,0],[n-li,0],[0,n-li]]}});var di=k(q=>{q.Patterns={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};var Pe={N1:3,N2:3,N3:40,N4:10};q.isValid=function(e){return e!=null&&e!==""&&!isNaN(e)&&e>=0&&e<=7};q.from=function(e){return q.isValid(e)?parseInt(e,10):void 0};q.getPenaltyN1=function(e){let n=e.size,i=0,o=0,s=0,d=null,h=null;for(let p=0;p<n;p++){o=s=0,d=h=null;for(let y=0;y<n;y++){let S=e.get(p,y);S===d?o++:(o>=5&&(i+=Pe.N1+(o-5)),d=S,o=1),S=e.get(y,p),S===h?s++:(s>=5&&(i+=Pe.N1+(s-5)),h=S,s=1)}o>=5&&(i+=Pe.N1+(o-5)),s>=5&&(i+=Pe.N1+(s-5))}return i};q.getPenaltyN2=function(e){let n=e.size,i=0;for(let o=0;o<n-1;o++)for(let s=0;s<n-1;s++){let d=e.get(o,s)+e.get(o,s+1)+e.get(o+1,s)+e.get(o+1,s+1);(d===4||d===0)&&i++}return i*Pe.N2};q.getPenaltyN3=function(e){let n=e.size,i=0,o=0,s=0;for(let d=0;d<n;d++){o=s=0;for(let h=0;h<n;h++)o=o<<1&2047|e.get(d,h),h>=10&&(o===1488||o===93)&&i++,s=s<<1&2047|e.get(h,d),h>=10&&(s===1488||s===93)&&i++}return i*Pe.N3};q.getPenaltyN4=function(e){let n=0,i=e.data.length;for(let s=0;s<i;s++)n+=e.data[s];return Math.abs(Math.ceil(n*100/i/5)-10)*Pe.N4};function ha(c,e,n){switch(c){case q.Patterns.PATTERN000:return(e+n)%2===0;case q.Patterns.PATTERN001:return e%2===0;case q.Patterns.PATTERN010:return n%3===0;case q.Patterns.PATTERN011:return(e+n)%3===0;case q.Patterns.PATTERN100:return(Math.floor(e/2)+Math.floor(n/3))%2===0;case q.Patterns.PATTERN101:return e*n%2+e*n%3===0;case q.Patterns.PATTERN110:return(e*n%2+e*n%3)%2===0;case q.Patterns.PATTERN111:return(e*n%3+(e+n)%2)%2===0;default:throw new Error("bad maskPattern:"+c)}}q.applyMask=function(e,n){let i=n.size;for(let o=0;o<i;o++)for(let s=0;s<i;s++)n.isReserved(s,o)||n.xor(s,o,ha(e,s,o))};q.getBestMask=function(e,n){let i=Object.keys(q.Patterns).length,o=0,s=1/0;for(let d=0;d<i;d++){n(d),q.applyMask(d,e);let h=q.getPenaltyN1(e)+q.getPenaltyN2(e)+q.getPenaltyN3(e)+q.getPenaltyN4(e);q.applyMask(d,e),h<s&&(s=h,o=d)}return o}});var Bn=k(Mn=>{var Se=kt(),Bt=[1,1,1,1,1,1,1,1,1,1,2,2,1,2,2,4,1,2,4,4,2,4,4,4,2,4,6,5,2,4,6,6,2,5,8,8,4,5,8,8,4,5,8,11,4,8,10,11,4,9,12,16,4,9,16,16,6,10,12,18,6,10,17,16,6,11,16,19,6,13,18,21,7,14,21,25,8,16,20,25,8,17,23,25,9,17,23,34,9,18,25,30,10,20,27,32,12,21,29,35,12,23,34,37,12,25,34,40,13,26,35,42,14,28,38,45,15,29,40,48,16,31,43,51,17,33,45,54,18,35,48,57,19,37,51,60,19,38,53,63,20,40,56,66,21,43,59,70,22,45,62,74,24,47,65,77,25,49,68,81],Ot=[7,10,13,17,10,16,22,28,15,26,36,44,20,36,52,64,26,48,72,88,36,64,96,112,40,72,108,130,48,88,132,156,60,110,160,192,72,130,192,224,80,150,224,264,96,176,260,308,104,198,288,352,120,216,320,384,132,240,360,432,144,280,408,480,168,308,448,532,180,338,504,588,196,364,546,650,224,416,600,700,224,442,644,750,252,476,690,816,270,504,750,900,300,560,810,960,312,588,870,1050,336,644,952,1110,360,700,1020,1200,390,728,1050,1260,420,784,1140,1350,450,812,1200,1440,480,868,1290,1530,510,924,1350,1620,540,980,1440,1710,570,1036,1530,1800,570,1064,1590,1890,600,1120,1680,1980,630,1204,1770,2100,660,1260,1860,2220,720,1316,1950,2310,750,1372,2040,2430];Mn.getBlocksCount=function(e,n){switch(n){case Se.L:return Bt[(e-1)*4+0];case Se.M:return Bt[(e-1)*4+1];case Se.Q:return Bt[(e-1)*4+2];case Se.H:return Bt[(e-1)*4+3];default:return}};Mn.getTotalCodewordsCount=function(e,n){switch(n){case Se.L:return Ot[(e-1)*4+0];case Se.M:return Ot[(e-1)*4+1];case Se.Q:return Ot[(e-1)*4+2];case Se.H:return Ot[(e-1)*4+3];default:return}}});var fi=k(Ut=>{var lt=new Uint8Array(512),qt=new Uint8Array(256);(function(){let e=1;for(let n=0;n<255;n++)lt[n]=e,qt[e]=n,e<<=1,e&256&&(e^=285);for(let n=255;n<512;n++)lt[n]=lt[n-255]})();Ut.log=function(e){if(e<1)throw new Error("log("+e+")");return qt[e]};Ut.exp=function(e){return lt[e]};Ut.mul=function(e,n){return e===0||n===0?0:lt[qt[e]+qt[n]]}});var hi=k(ct=>{var On=fi();ct.mul=function(e,n){let i=new Uint8Array(e.length+n.length-1);for(let o=0;o<e.length;o++)for(let s=0;s<n.length;s++)i[o+s]^=On.mul(e[o],n[s]);return i};ct.mod=function(e,n){let i=new Uint8Array(e);for(;i.length-n.length>=0;){let o=i[0];for(let d=0;d<n.length;d++)i[d]^=On.mul(n[d],o);let s=0;for(;s<i.length&&i[s]===0;)s++;i=i.slice(s)}return i};ct.generateECPolynomial=function(e){let n=new Uint8Array([1]);for(let i=0;i<e;i++)n=ct.mul(n,new Uint8Array([1,On.exp(i)]));return n}});var mi=k((So,gi)=>{var pi=hi();function qn(c){this.genPoly=void 0,this.degree=c,this.degree&&this.initialize(this.degree)}qn.prototype.initialize=function(e){this.degree=e,this.genPoly=pi.generateECPolynomial(this.degree)};qn.prototype.encode=function(e){if(!this.genPoly)throw new Error("Encoder not initialized");let n=new Uint8Array(e.length+this.degree);n.set(e);let i=pi.mod(n,this.genPoly),o=this.degree-i.length;if(o>0){let s=new Uint8Array(this.degree);return s.set(i,o),s}return i};gi.exports=qn});var Un=k(bi=>{bi.isValid=function(e){return!isNaN(e)&&e>=1&&e<=40}});var Wn=k(pe=>{var wi="[0-9]+",pa="[A-Z $%*+\\-./:]+",ut="(?:[u3000-u303F]|[u3040-u309F]|[u30A0-u30FF]|[uFF00-uFFEF]|[u4E00-u9FAF]|[u2605-u2606]|[u2190-u2195]|u203B|[u2010u2015u2018u2019u2025u2026u201Cu201Du2225u2260]|[u0391-u0451]|[u00A7u00A8u00B1u00B4u00D7u00F7])+";ut=ut.replace(/u/g,"\\u");var ga="(?:(?![A-Z0-9 $%*+\\-./:]|"+ut+`)(?:.|[\r
]))+`;pe.KANJI=new RegExp(ut,"g");pe.BYTE_KANJI=new RegExp("[^A-Z0-9 $%*+\\-./:]+","g");pe.BYTE=new RegExp(ga,"g");pe.NUMERIC=new RegExp(wi,"g");pe.ALPHANUMERIC=new RegExp(pa,"g");var ma=new RegExp("^"+ut+"$"),ba=new RegExp("^"+wi+"$"),wa=new RegExp("^[A-Z0-9 $%*+\\-./:]+$");pe.testKanji=function(e){return ma.test(e)};pe.testNumeric=function(e){return ba.test(e)};pe.testAlphanumeric=function(e){return wa.test(e)}});var Ae=k(V=>{var ya=Un(),$n=Wn();V.NUMERIC={id:"Numeric",bit:1,ccBits:[10,12,14]};V.ALPHANUMERIC={id:"Alphanumeric",bit:2,ccBits:[9,11,13]};V.BYTE={id:"Byte",bit:4,ccBits:[8,16,16]};V.KANJI={id:"Kanji",bit:8,ccBits:[8,10,12]};V.MIXED={bit:-1};V.getCharCountIndicator=function(e,n){if(!e.ccBits)throw new Error("Invalid mode: "+e);if(!ya.isValid(n))throw new Error("Invalid version: "+n);return n>=1&&n<10?e.ccBits[0]:n<27?e.ccBits[1]:e.ccBits[2]};V.getBestModeForData=function(e){return $n.testNumeric(e)?V.NUMERIC:$n.testAlphanumeric(e)?V.ALPHANUMERIC:$n.testKanji(e)?V.KANJI:V.BYTE};V.toString=function(e){if(e&&e.id)return e.id;throw new Error("Invalid mode")};V.isValid=function(e){return e&&e.bit&&e.ccBits};function Ea(c){if(typeof c!="string")throw new Error("Param is not a string");switch(c.toLowerCase()){case"numeric":return V.NUMERIC;case"alphanumeric":return V.ALPHANUMERIC;case"kanji":return V.KANJI;case"byte":return V.BYTE;default:throw new Error("Unknown mode: "+c)}}V.from=function(e,n){if(V.isValid(e))return e;try{return Ea(e)}catch{return n}}});var Ai=k(Fe=>{var Wt=ve(),va=Bn(),yi=kt(),Te=Ae(),Hn=Un(),vi=7973,Ei=Wt.getBCHDigit(vi);function Sa(c,e,n){for(let i=1;i<=40;i++)if(e<=Fe.getCapacity(i,n,c))return i}function Si(c,e){return Te.getCharCountIndicator(c,e)+4}function Aa(c,e){let n=0;return c.forEach(function(i){let o=Si(i.mode,e);n+=o+i.getBitsLength()}),n}function Ta(c,e){for(let n=1;n<=40;n++)if(Aa(c,n)<=Fe.getCapacity(n,e,Te.MIXED))return n}Fe.from=function(e,n){return Hn.isValid(e)?parseInt(e,10):n};Fe.getCapacity=function(e,n,i){if(!Hn.isValid(e))throw new Error("Invalid QR Code version");typeof i>"u"&&(i=Te.BYTE);let o=Wt.getSymbolTotalCodewords(e),s=va.getTotalCodewordsCount(e,n),d=(o-s)*8;if(i===Te.MIXED)return d;let h=d-Si(i,e);switch(i){case Te.NUMERIC:return Math.floor(h/10*3);case Te.ALPHANUMERIC:return Math.floor(h/11*2);case Te.KANJI:return Math.floor(h/13);case Te.BYTE:default:return Math.floor(h/8)}};Fe.getBestVersionForData=function(e,n){let i,o=yi.from(n,yi.M);if(Array.isArray(e)){if(e.length>1)return Ta(e,o);if(e.length===0)return 1;i=e[0]}else i=e;return Sa(i.mode,i.getLength(),o)};Fe.getEncodedBits=function(e){if(!Hn.isValid(e)||e<7)throw new Error("Invalid QR Code version");let n=e<<12;for(;Wt.getBCHDigit(n)-Ei>=0;)n^=vi<<Wt.getBCHDigit(n)-Ei;return e<<12|n}});var Ci=k(_i=>{var zn=ve(),Ri=1335,Ra=21522,Ti=zn.getBCHDigit(Ri);_i.getEncodedBits=function(e,n){let i=e.bit<<3|n,o=i<<10;for(;zn.getBCHDigit(o)-Ti>=0;)o^=Ri<<zn.getBCHDigit(o)-Ti;return(i<<10|o)^Ra}});var Ni=k((xo,xi)=>{var _a=Ae();function ze(c){this.mode=_a.NUMERIC,this.data=c.toString()}ze.getBitsLength=function(e){return 10*Math.floor(e/3)+(e%3?e%3*3+1:0)};ze.prototype.getLength=function(){return this.data.length};ze.prototype.getBitsLength=function(){return ze.getBitsLength(this.data.length)};ze.prototype.write=function(e){let n,i,o;for(n=0;n+3<=this.data.length;n+=3)i=this.data.substr(n,3),o=parseInt(i,10),e.put(o,10);let s=this.data.length-n;s>0&&(i=this.data.substr(n),o=parseInt(i,10),e.put(o,s*3+1))};xi.exports=ze});var Ii=k((No,Li)=>{var Ca=Ae(),Vn=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"," ","$","%","*","+","-",".","/",":"];function Ve(c){this.mode=Ca.ALPHANUMERIC,this.data=c}Ve.getBitsLength=function(e){return 11*Math.floor(e/2)+6*(e%2)};Ve.prototype.getLength=function(){return this.data.length};Ve.prototype.getBitsLength=function(){return Ve.getBitsLength(this.data.length)};Ve.prototype.write=function(e){let n;for(n=0;n+2<=this.data.length;n+=2){let i=Vn.indexOf(this.data[n])*45;i+=Vn.indexOf(this.data[n+1]),e.put(i,11)}this.data.length%2&&e.put(Vn.indexOf(this.data[n]),6)};Li.exports=Ve});var Pi=k((Lo,Di)=>{var xa=Ae();function Ge(c){this.mode=xa.BYTE,typeof c=="string"?this.data=new TextEncoder().encode(c):this.data=new Uint8Array(c)}Ge.getBitsLength=function(e){return e*8};Ge.prototype.getLength=function(){return this.data.length};Ge.prototype.getBitsLength=function(){return Ge.getBitsLength(this.data.length)};Ge.prototype.write=function(c){for(let e=0,n=this.data.length;e<n;e++)c.put(this.data[e],8)};Di.exports=Ge});var ki=k((Io,Fi)=>{var Na=Ae(),La=ve();function Qe(c){this.mode=Na.KANJI,this.data=c}Qe.getBitsLength=function(e){return e*13};Qe.prototype.getLength=function(){return this.data.length};Qe.prototype.getBitsLength=function(){return Qe.getBitsLength(this.data.length)};Qe.prototype.write=function(c){let e;for(e=0;e<this.data.length;e++){let n=La.toSJIS(this.data[e]);if(n>=33088&&n<=40956)n-=33088;else if(n>=57408&&n<=60351)n-=49472;else throw new Error("Invalid SJIS character: "+this.data[e]+`
Make sure your charset is UTF-8`);n=(n>>>8&255)*192+(n&255),c.put(n,13)}};Fi.exports=Qe});var Mi=k((Do,Gn)=>{"use strict";var dt={single_source_shortest_paths:function(c,e,n){var i={},o={};o[e]=0;var s=dt.PriorityQueue.make();s.push(e,0);for(var d,h,p,y,S,D,_,H,G;!s.empty();){d=s.pop(),h=d.value,y=d.cost,S=c[h]||{};for(p in S)S.hasOwnProperty(p)&&(D=S[p],_=y+D,H=o[p],G=typeof o[p]>"u",(G||H>_)&&(o[p]=_,s.push(p,_),i[p]=h))}if(typeof n<"u"&&typeof o[n]>"u"){var Q=["Could not find a path from ",e," to ",n,"."].join("");throw new Error(Q)}return i},extract_shortest_path_from_predecessor_list:function(c,e){for(var n=[],i=e,o;i;)n.push(i),o=c[i],i=c[i];return n.reverse(),n},find_path:function(c,e,n){var i=dt.single_source_shortest_paths(c,e,n);return dt.extract_shortest_path_from_predecessor_list(i,n)},PriorityQueue:{make:function(c){var e=dt.PriorityQueue,n={},i;c=c||{};for(i in e)e.hasOwnProperty(i)&&(n[i]=e[i]);return n.queue=[],n.sorter=c.sorter||e.default_sorter,n},default_sorter:function(c,e){return c.cost-e.cost},push:function(c,e){var n={value:c,cost:e};this.queue.push(n),this.queue.sort(this.sorter)},pop:function(){return this.queue.shift()},empty:function(){return this.queue.length===0}}};typeof Gn<"u"&&(Gn.exports=dt)});var zi=k(Ye=>{var P=Ae(),qi=Ni(),Ui=Ii(),Wi=Pi(),$i=ki(),ft=Wn(),$t=ve(),Ia=Mi();function Bi(c){return unescape(encodeURIComponent(c)).length}function ht(c,e,n){let i=[],o;for(;(o=c.exec(n))!==null;)i.push({data:o[0],index:o.index,mode:e,length:o[0].length});return i}function Hi(c){let e=ht(ft.NUMERIC,P.NUMERIC,c),n=ht(ft.ALPHANUMERIC,P.ALPHANUMERIC,c),i,o;return $t.isKanjiModeEnabled()?(i=ht(ft.BYTE,P.BYTE,c),o=ht(ft.KANJI,P.KANJI,c)):(i=ht(ft.BYTE_KANJI,P.BYTE,c),o=[]),e.concat(n,i,o).sort(function(d,h){return d.index-h.index}).map(function(d){return{data:d.data,mode:d.mode,length:d.length}})}function Qn(c,e){switch(e){case P.NUMERIC:return qi.getBitsLength(c);case P.ALPHANUMERIC:return Ui.getBitsLength(c);case P.KANJI:return $i.getBitsLength(c);case P.BYTE:return Wi.getBitsLength(c)}}function Da(c){return c.reduce(function(e,n){let i=e.length-1>=0?e[e.length-1]:null;return i&&i.mode===n.mode?(e[e.length-1].data+=n.data,e):(e.push(n),e)},[])}function Pa(c){let e=[];for(let n=0;n<c.length;n++){let i=c[n];switch(i.mode){case P.NUMERIC:e.push([i,{data:i.data,mode:P.ALPHANUMERIC,length:i.length},{data:i.data,mode:P.BYTE,length:i.length}]);break;case P.ALPHANUMERIC:e.push([i,{data:i.data,mode:P.BYTE,length:i.length}]);break;case P.KANJI:e.push([i,{data:i.data,mode:P.BYTE,length:Bi(i.data)}]);break;case P.BYTE:e.push([{data:i.data,mode:P.BYTE,length:Bi(i.data)}])}}return e}function Fa(c,e){let n={},i={start:{}},o=["start"];for(let s=0;s<c.length;s++){let d=c[s],h=[];for(let p=0;p<d.length;p++){let y=d[p],S=""+s+p;h.push(S),n[S]={node:y,lastCount:0},i[S]={};for(let D=0;D<o.length;D++){let _=o[D];n[_]&&n[_].node.mode===y.mode?(i[_][S]=Qn(n[_].lastCount+y.length,y.mode)-Qn(n[_].lastCount,y.mode),n[_].lastCount+=y.length):(n[_]&&(n[_].lastCount=y.length),i[_][S]=Qn(y.length,y.mode)+4+P.getCharCountIndicator(y.mode,e))}}o=h}for(let s=0;s<o.length;s++)i[o[s]].end=0;return{map:i,table:n}}function Oi(c,e){let n,i=P.getBestModeForData(c);if(n=P.from(e,i),n!==P.BYTE&&n.bit<i.bit)throw new Error('"'+c+'" cannot be encoded with mode '+P.toString(n)+`.
 Suggested mode is: `+P.toString(i));switch(n===P.KANJI&&!$t.isKanjiModeEnabled()&&(n=P.BYTE),n){case P.NUMERIC:return new qi(c);case P.ALPHANUMERIC:return new Ui(c);case P.KANJI:return new $i(c);case P.BYTE:return new Wi(c)}}Ye.fromArray=function(e){return e.reduce(function(n,i){return typeof i=="string"?n.push(Oi(i,null)):i.data&&n.push(Oi(i.data,i.mode)),n},[])};Ye.fromString=function(e,n){let i=Hi(e,$t.isKanjiModeEnabled()),o=Pa(i),s=Fa(o,n),d=Ia.find_path(s.map,"start","end"),h=[];for(let p=1;p<d.length-1;p++)h.push(s.table[d[p]].node);return Ye.fromArray(Da(h))};Ye.rawSplit=function(e){return Ye.fromArray(Hi(e,$t.isKanjiModeEnabled()))}});var Gi=k(Vi=>{var zt=ve(),Yn=kt(),ka=ii(),Ma=ai(),Ba=oi(),Oa=ui(),Xn=di(),Jn=Bn(),qa=mi(),Ht=Ai(),Ua=Ci(),Wa=Ae(),jn=zi();function $a(c,e){let n=c.size,i=Oa.getPositions(e);for(let o=0;o<i.length;o++){let s=i[o][0],d=i[o][1];for(let h=-1;h<=7;h++)if(!(s+h<=-1||n<=s+h))for(let p=-1;p<=7;p++)d+p<=-1||n<=d+p||(h>=0&&h<=6&&(p===0||p===6)||p>=0&&p<=6&&(h===0||h===6)||h>=2&&h<=4&&p>=2&&p<=4?c.set(s+h,d+p,!0,!0):c.set(s+h,d+p,!1,!0))}}function Ha(c){let e=c.size;for(let n=8;n<e-8;n++){let i=n%2===0;c.set(n,6,i,!0),c.set(6,n,i,!0)}}function za(c,e){let n=Ba.getPositions(e);for(let i=0;i<n.length;i++){let o=n[i][0],s=n[i][1];for(let d=-2;d<=2;d++)for(let h=-2;h<=2;h++)d===-2||d===2||h===-2||h===2||d===0&&h===0?c.set(o+d,s+h,!0,!0):c.set(o+d,s+h,!1,!0)}}function Va(c,e){let n=c.size,i=Ht.getEncodedBits(e),o,s,d;for(let h=0;h<18;h++)o=Math.floor(h/3),s=h%3+n-8-3,d=(i>>h&1)===1,c.set(o,s,d,!0),c.set(s,o,d,!0)}function Kn(c,e,n){let i=c.size,o=Ua.getEncodedBits(e,n),s,d;for(s=0;s<15;s++)d=(o>>s&1)===1,s<6?c.set(s,8,d,!0):s<8?c.set(s+1,8,d,!0):c.set(i-15+s,8,d,!0),s<8?c.set(8,i-s-1,d,!0):s<9?c.set(8,15-s-1+1,d,!0):c.set(8,15-s-1,d,!0);c.set(i-8,8,1,!0)}function Ga(c,e){let n=c.size,i=-1,o=n-1,s=7,d=0;for(let h=n-1;h>0;h-=2)for(h===6&&h--;;){for(let p=0;p<2;p++)if(!c.isReserved(o,h-p)){let y=!1;d<e.length&&(y=(e[d]>>>s&1)===1),c.set(o,h-p,y),s--,s===-1&&(d++,s=7)}if(o+=i,o<0||n<=o){o-=i,i=-i;break}}}function Qa(c,e,n){let i=new ka;n.forEach(function(p){i.put(p.mode.bit,4),i.put(p.getLength(),Wa.getCharCountIndicator(p.mode,c)),p.write(i)});let o=zt.getSymbolTotalCodewords(c),s=Jn.getTotalCodewordsCount(c,e),d=(o-s)*8;for(i.getLengthInBits()+4<=d&&i.put(0,4);i.getLengthInBits()%8!==0;)i.putBit(0);let h=(d-i.getLengthInBits())/8;for(let p=0;p<h;p++)i.put(p%2?17:236,8);return Ya(i,c,e)}function Ya(c,e,n){let i=zt.getSymbolTotalCodewords(e),o=Jn.getTotalCodewordsCount(e,n),s=i-o,d=Jn.getBlocksCount(e,n),h=i%d,p=d-h,y=Math.floor(i/d),S=Math.floor(s/d),D=S+1,_=y-S,H=new qa(_),G=0,Q=new Array(d),Je=new Array(d),le=0,qe=new Uint8Array(c.buffer);for(let L=0;L<d;L++){let ue=L<p?S:D;Q[L]=qe.slice(G,G+ue),Je[L]=H.encode(Q[L]),G+=ue,le=Math.max(le,ue)}let me=new Uint8Array(i),Re=0,Z,M;for(Z=0;Z<le;Z++)for(M=0;M<d;M++)Z<Q[M].length&&(me[Re++]=Q[M][Z]);for(Z=0;Z<_;Z++)for(M=0;M<d;M++)me[Re++]=Je[M][Z];return me}function ja(c,e,n,i){let o;if(Array.isArray(c))o=jn.fromArray(c);else if(typeof c=="string"){let y=e;if(!y){let S=jn.rawSplit(c);y=Ht.getBestVersionForData(S,n)}o=jn.fromString(c,y||40)}else throw new Error("Invalid data");let s=Ht.getBestVersionForData(o,n);if(!s)throw new Error("The amount of data is too big to be stored in a QR Code");if(!e)e=s;else if(e<s)throw new Error(`
The chosen QR Code version cannot contain this amount of data.
Minimum version required to store current data is: `+s+`.
`);let d=Qa(e,n,o),h=zt.getSymbolSize(e),p=new Ma(h);return $a(p,e),Ha(p),za(p,e),Kn(p,n,0),e>=7&&Va(p,e),Ga(p,d),isNaN(i)&&(i=Xn.getBestMask(p,Kn.bind(null,p,n))),Xn.applyMask(i,p),Kn(p,n,i),{modules:p,version:e,errorCorrectionLevel:n,maskPattern:i,segments:o}}Vi.create=function(e,n){if(typeof e>"u"||e==="")throw new Error("No input text");let i=Yn.M,o,s;return typeof n<"u"&&(i=Yn.from(n.errorCorrectionLevel,Yn.M),o=Ht.from(n.version),s=Xn.from(n.maskPattern),n.toSJISFunc&&zt.setToSJISFunction(n.toSJISFunc)),ja(e,o,i,s)}});var Zn=k(ke=>{function Qi(c){if(typeof c=="number"&&(c=c.toString()),typeof c!="string")throw new Error("Color should be defined as hex string");let e=c.slice().replace("#","").split("");if(e.length<3||e.length===5||e.length>8)throw new Error("Invalid hex color: "+c);(e.length===3||e.length===4)&&(e=Array.prototype.concat.apply([],e.map(function(i){return[i,i]}))),e.length===6&&e.push("F","F");let n=parseInt(e.join(""),16);return{r:n>>24&255,g:n>>16&255,b:n>>8&255,a:n&255,hex:"#"+e.slice(0,6).join("")}}ke.getOptions=function(e){e||(e={}),e.color||(e.color={});let n=typeof e.margin>"u"||e.margin===null||e.margin<0?4:e.margin,i=e.width&&e.width>=21?e.width:void 0,o=e.scale||4;return{width:i,scale:i?4:o,margin:n,color:{dark:Qi(e.color.dark||"#000000ff"),light:Qi(e.color.light||"#ffffffff")},type:e.type,rendererOpts:e.rendererOpts||{}}};ke.getScale=function(e,n){return n.width&&n.width>=e+n.margin*2?n.width/(e+n.margin*2):n.scale};ke.getImageWidth=function(e,n){let i=ke.getScale(e,n);return Math.floor((e+n.margin*2)*i)};ke.qrToImageData=function(e,n,i){let o=n.modules.size,s=n.modules.data,d=ke.getScale(o,i),h=Math.floor((o+i.margin*2)*d),p=i.margin*d,y=[i.color.light,i.color.dark];for(let S=0;S<h;S++)for(let D=0;D<h;D++){let _=(S*h+D)*4,H=i.color.light;if(S>=p&&D>=p&&S<h-p&&D<h-p){let G=Math.floor((S-p)/d),Q=Math.floor((D-p)/d);H=y[s[G*o+Q]?1:0]}e[_++]=H.r,e[_++]=H.g,e[_++]=H.b,e[_]=H.a}}});var Yi=k(Vt=>{var er=Zn();function Ka(c,e,n){c.clearRect(0,0,e.width,e.height),e.style||(e.style={}),e.height=n,e.width=n,e.style.height=n+"px",e.style.width=n+"px"}function Xa(){try{return document.createElement("canvas")}catch{throw new Error("You need to specify a canvas element")}}Vt.render=function(e,n,i){let o=i,s=n;typeof o>"u"&&(!n||!n.getContext)&&(o=n,n=void 0),n||(s=Xa()),o=er.getOptions(o);let d=er.getImageWidth(e.modules.size,o),h=s.getContext("2d"),p=h.createImageData(d,d);return er.qrToImageData(p.data,e,o),Ka(h,s,d),h.putImageData(p,0,0),s};Vt.renderToDataURL=function(e,n,i){let o=i;typeof o>"u"&&(!n||!n.getContext)&&(o=n,n=void 0),o||(o={});let s=Vt.render(e,n,o),d=o.type||"image/png",h=o.rendererOpts||{};return s.toDataURL(d,h.quality)}});var Xi=k(Ki=>{var Ja=Zn();function ji(c,e){let n=c.a/255,i=e+'="'+c.hex+'"';return n<1?i+" "+e+'-opacity="'+n.toFixed(2).slice(1)+'"':i}function tr(c,e,n){let i=c+e;return typeof n<"u"&&(i+=" "+n),i}function Za(c,e,n){let i="",o=0,s=!1,d=0;for(let h=0;h<c.length;h++){let p=Math.floor(h%e),y=Math.floor(h/e);!p&&!s&&(s=!0),c[h]?(d++,h>0&&p>0&&c[h-1]||(i+=s?tr("M",p+n,.5+y+n):tr("m",o,0),o=0,s=!1),p+1<e&&c[h+1]||(i+=tr("h",d),d=0)):o++}return i}Ki.render=function(e,n,i){let o=Ja.getOptions(n),s=e.modules.size,d=e.modules.data,h=s+o.margin*2,p=o.color.light.a?"<path "+ji(o.color.light,"fill")+' d="M0 0h'+h+"v"+h+'H0z"/>':"",y="<path "+ji(o.color.dark,"stroke")+' d="'+Za(d,s,o.margin)+'"/>',S='viewBox="0 0 '+h+" "+h+'"',_='<svg xmlns="http://www.w3.org/2000/svg" '+(o.width?'width="'+o.width+'" height="'+o.width+'" ':"")+S+' shape-rendering="crispEdges">'+p+y+`</svg>
`;return typeof i=="function"&&i(null,_),_}});var Zi=k(pt=>{var eo=ti(),nr=Gi(),Ji=Yi(),to=Xi();function rr(c,e,n,i,o){let s=[].slice.call(arguments,1),d=s.length,h=typeof s[d-1]=="function";if(!h&&!eo())throw new Error("Callback required as last argument");if(h){if(d<2)throw new Error("Too few arguments provided");d===2?(o=n,n=e,e=i=void 0):d===3&&(e.getContext&&typeof o>"u"?(o=i,i=void 0):(o=i,i=n,n=e,e=void 0))}else{if(d<1)throw new Error("Too few arguments provided");return d===1?(n=e,e=i=void 0):d===2&&!e.getContext&&(i=n,n=e,e=void 0),new Promise(function(p,y){try{let S=nr.create(n,i);p(c(S,e,i))}catch(S){y(S)}})}try{let p=nr.create(n,i);o(null,c(p,e,i))}catch(p){o(p)}}pt.create=nr.create;pt.toCanvas=rr.bind(null,Ji.render);pt.toDataURL=rr.bind(null,Ji.renderToDataURL);pt.toString=rr.bind(null,function(c,e,n){return to.render(c,n)})});var ts={};Pn(ts,{AddAccountModal:()=>Me});var Gt,es,Me,Qt=Dn(()=>{Gt=require("obsidian"),es=Kr(Zi());Y();Me=class extends Gt.Modal{plugin;logger;uuid=null;pollInterval=null;qrContainer;statusEl;consecutiveErrors=0;loginSuccessful=!1;constructor(e,n){super(e),this.plugin=n,this.logger=new K("AddAccountModal")}async onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("wewe-rss-add-account-modal"),e.createEl("h2",{text:"Add WeChat Account"});let n=e.createEl("div",{cls:"wewe-rss-modal-instructions"});n.createEl("p",{text:"Scan the QR code with WeChat to authorize access to your reading list."}),n.createEl("p",{text:"Steps:",cls:"wewe-rss-instructions-title"});let i=n.createEl("ol",{cls:"wewe-rss-steps-list"});i.createEl("li",{text:"Open WeChat on your phone"}),i.createEl("li",{text:'Tap "Discover" \u2192 "Scan QR Code"'}),i.createEl("li",{text:"Scan the code below"}),i.createEl("li",{text:"Authorize the login on your phone"}),this.qrContainer=e.createEl("div",{cls:"wewe-rss-qr-container"}),this.qrContainer.createEl("div",{text:"Generating QR code...",cls:"wewe-rss-loading"}),this.statusEl=e.createEl("div",{cls:"wewe-rss-status-message"}),this.statusEl.createEl("p",{text:"Waiting for scan...",cls:"wewe-rss-status-text"});let o=e.createEl("div",{cls:"wewe-rss-modal-buttons"});o.createEl("button",{text:"Cancel",cls:"wewe-rss-btn"}).addEventListener("click",()=>{this.close()}),o.createEl("button",{text:"Refresh QR Code",cls:"wewe-rss-btn"}).addEventListener("click",async()=>{await this.generateQRCode()}),await this.generateQRCode()}async generateQRCode(){try{this.qrContainer.empty(),this.qrContainer.createEl("div",{text:"Generating QR code...",cls:"wewe-rss-loading"});let{uuid:e,scanUrl:n}=await this.plugin.accountService.createAccount();this.uuid=e,this.logger.info("QR code generated:",{uuid:e,scanUrl:n});let i=this.qrContainer.createEl("canvas",{cls:"wewe-rss-qr-code"});await es.default.toCanvas(i,n,{width:256,margin:2,color:{dark:"#000000",light:"#FFFFFF"}}),this.updateStatus("Please scan the QR code with WeChat","pending"),this.consecutiveErrors=0,this.loginSuccessful=!1,this.startPolling()}catch(e){this.logger.error("Failed to generate QR code:",e),this.showError(e.message||"Failed to generate QR code. Please try again.")}}startPolling(){this.pollInterval&&window.clearInterval(this.pollInterval),this.pollInterval=window.setInterval(async()=>{await this.checkLoginStatus()},2e3),window.setTimeout(()=>{this.pollInterval&&(window.clearInterval(this.pollInterval),this.pollInterval=null,this.updateStatus("QR code expired. Please refresh to generate a new one.","error"))},5*60*1e3)}async checkLoginStatus(){if(!(!this.uuid||this.loginSuccessful))try{let e=await this.plugin.accountService.checkLoginStatus(this.uuid);e?(this.loginSuccessful=!0,this.logger.info("Account added successfully:",e),this.pollInterval&&(window.clearInterval(this.pollInterval),this.pollInterval=null),this.consecutiveErrors=0,this.updateStatus("Account added successfully!","success"),new Gt.Notice(`WeChat account "${e.name}" added successfully!`),window.setTimeout(()=>{this.close()},1e3)):this.consecutiveErrors=0}catch(e){if(this.loginSuccessful){this.logger.debug("Ignoring polling error after successful login");return}if(this.logger.error("Failed to check login status:",e),this.consecutiveErrors++,this.consecutiveErrors>=3){this.pollInterval&&(window.clearInterval(this.pollInterval),this.pollInterval=null);let n=e.message||"Failed to connect to server after multiple attempts";this.showError(n)}else this.updateStatus(`Connection issue (${this.consecutiveErrors}/3). Retrying...`,"pending")}}updateStatus(e,n){this.statusEl.empty();let i=this.statusEl.createEl("p",{cls:"wewe-rss-status-text"});n==="pending"?i.innerHTML=`<span class="wewe-rss-status-icon">\u23F3</span> ${e}`:n==="success"?i.innerHTML=`<span class="wewe-rss-status-icon" style="color: var(--color-green)">\u2713</span> ${e}`:n==="error"&&(i.innerHTML=`<span class="wewe-rss-status-icon" style="color: var(--color-red)">\u2717</span> ${e}`)}showError(e){this.qrContainer.empty();let n=this.qrContainer.createEl("div",{cls:"wewe-rss-error-container"});n.createEl("p",{text:e,cls:"wewe-rss-error-message"});let i=n.createEl("div",{cls:"wewe-rss-error-actions"});i.createEl("button",{text:"Try Again",cls:"wewe-rss-btn"}).addEventListener("click",async()=>{await this.generateQRCode()}),i.createEl("button",{text:"Check Server Status",cls:"wewe-rss-btn-secondary"}).addEventListener("click",()=>{window.open(`${this.plugin.settings.platformUrl}`,"_blank")}),this.updateStatus(e,"error")}onClose(){this.pollInterval&&(window.clearInterval(this.pollInterval),this.pollInterval=null);let{contentEl:e}=this;e.empty()}}});var rs=k((Jt,Oe)=>{var Kt=void 0,Xt=function(c){return Kt||(Kt=new Promise(function(e,n){var i=typeof c<"u"?c:{},o=i.onAbort;i.onAbort=function(t){n(new Error(t)),o&&o(t)},i.postRun=i.postRun||[],i.postRun.push(function(){e(i)}),Oe=void 0;var s;s||=typeof i<"u"?i:{};var d=typeof window=="object",h=typeof WorkerGlobalScope<"u",p=typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string"&&process.type!="renderer";s.onRuntimeInitialized=function(){function t(f,w){switch(typeof w){case"boolean":ta(f,w?1:0);break;case"number":Js(f,w);break;case"string":Zs(f,w,-1,-1);break;case"object":if(w===null)Vr(f);else if(w.length!=null){var v=It(w,Lt);ea(f,v,w.length,-1),Dt(v)}else Pt(f,"Wrong API use : tried to return a value of an unknown type ("+w+").",-1);break;default:Vr(f)}}function r(f,w){for(var v=[],R=0;R<f;R+=1){var C=de(w+4*R,"i32"),F=Qs(C);if(F===1||F===2)C=Xs(C);else if(F===3)C=js(C);else if(F===4){F=C,C=Ys(F),F=Ks(F);for(var ae=new Uint8Array(C),ne=0;ne<C;ne+=1)ae[ne]=M[F+ne];C=ae}else C=null;v.push(C)}return v}function a(f,w){this.Qa=f,this.db=w,this.Oa=1,this.lb=[]}function l(f,w){if(this.db=w,w=tt(f)+1,this.eb=Nn(w),this.eb===null)throw Error("Unable to allocate memory for the SQL string");fe(f,L,this.eb,w),this.kb=this.eb,this.Za=this.pb=null}function u(f){if(this.filename="dbfile_"+(4294967295*Math.random()>>>0),f!=null){var w=this.filename,v="/",R=w;if(v&&(v=typeof v=="string"?v:bn(v),R=w?pn(v+"/"+w):v),w=wr(!0,!0),R=As(R,w),f){if(typeof f=="string"){v=Array(f.length);for(var C=0,F=f.length;C<F;++C)v[C]=f.charCodeAt(C);f=v}_t(R,w|146),v=He(R,577),kr(v,f,0,f.length,0),An(v),_t(R,w)}}this.handleError(T(this.filename,g)),this.db=de(g,"i32"),Qr(this.db),this.fb={},this.Sa={}}var g=Ee(4),b=s.cwrap,T=b("sqlite3_open","number",["string","number"]),I=b("sqlite3_close_v2","number",["number"]),N=b("sqlite3_exec","number",["number","string","number","number","number"]),$=b("sqlite3_changes","number",["number"]),J=b("sqlite3_prepare_v2","number",["number","string","number","number","number"]),Ur=b("sqlite3_sql","string",["number"]),Ls=b("sqlite3_normalized_sql","string",["number"]),Wr=b("sqlite3_prepare_v2","number",["number","number","number","number","number"]),Is=b("sqlite3_bind_text","number",["number","number","number","number","number"]),$r=b("sqlite3_bind_blob","number",["number","number","number","number","number"]),Ds=b("sqlite3_bind_double","number",["number","number","number"]),Ps=b("sqlite3_bind_int","number",["number","number","number"]),Fs=b("sqlite3_bind_parameter_index","number",["number","string"]),ks=b("sqlite3_step","number",["number"]),Ms=b("sqlite3_errmsg","string",["number"]),Bs=b("sqlite3_column_count","number",["number"]),Os=b("sqlite3_data_count","number",["number"]),qs=b("sqlite3_column_double","number",["number","number"]),Hr=b("sqlite3_column_text","string",["number","number"]),Us=b("sqlite3_column_blob","number",["number","number"]),Ws=b("sqlite3_column_bytes","number",["number","number"]),$s=b("sqlite3_column_type","number",["number","number"]),Hs=b("sqlite3_column_name","string",["number","number"]),zs=b("sqlite3_reset","number",["number"]),Vs=b("sqlite3_clear_bindings","number",["number"]),Gs=b("sqlite3_finalize","number",["number"]),zr=b("sqlite3_create_function_v2","number","number string number number number number number number number".split(" ")),Qs=b("sqlite3_value_type","number",["number"]),Ys=b("sqlite3_value_bytes","number",["number"]),js=b("sqlite3_value_text","string",["number"]),Ks=b("sqlite3_value_blob","number",["number"]),Xs=b("sqlite3_value_double","number",["number"]),Js=b("sqlite3_result_double","",["number","number"]),Vr=b("sqlite3_result_null","",["number"]),Zs=b("sqlite3_result_text","",["number","string","number","number"]),ea=b("sqlite3_result_blob","",["number","number","number","number"]),ta=b("sqlite3_result_int","",["number","number"]),Pt=b("sqlite3_result_error","",["number","string","number"]),Gr=b("sqlite3_aggregate_context","number",["number","number"]),Qr=b("RegisterExtensionFunctions","number",["number"]),Yr=b("sqlite3_update_hook","number",["number","number","number"]);a.prototype.bind=function(f){if(!this.Qa)throw"Statement closed";return this.reset(),Array.isArray(f)?this.Cb(f):f!=null&&typeof f=="object"?this.Db(f):!0},a.prototype.step=function(){if(!this.Qa)throw"Statement closed";this.Oa=1;var f=ks(this.Qa);switch(f){case 100:return!0;case 101:return!1;default:throw this.db.handleError(f)}},a.prototype.wb=function(f){return f==null&&(f=this.Oa,this.Oa+=1),qs(this.Qa,f)},a.prototype.Gb=function(f){if(f==null&&(f=this.Oa,this.Oa+=1),f=Hr(this.Qa,f),typeof BigInt!="function")throw Error("BigInt is not supported");return BigInt(f)},a.prototype.Hb=function(f){return f==null&&(f=this.Oa,this.Oa+=1),Hr(this.Qa,f)},a.prototype.getBlob=function(f){f==null&&(f=this.Oa,this.Oa+=1);var w=Ws(this.Qa,f);f=Us(this.Qa,f);for(var v=new Uint8Array(w),R=0;R<w;R+=1)v[R]=M[f+R];return v},a.prototype.get=function(f,w){w=w||{},f!=null&&this.bind(f)&&this.step(),f=[];for(var v=Os(this.Qa),R=0;R<v;R+=1)switch($s(this.Qa,R)){case 1:var C=w.useBigInt?this.Gb(R):this.wb(R);f.push(C);break;case 2:f.push(this.wb(R));break;case 3:f.push(this.Hb(R));break;case 4:f.push(this.getBlob(R));break;default:f.push(null)}return f},a.prototype.getColumnNames=function(){for(var f=[],w=Bs(this.Qa),v=0;v<w;v+=1)f.push(Hs(this.Qa,v));return f},a.prototype.getAsObject=function(f,w){f=this.get(f,w),w=this.getColumnNames();for(var v={},R=0;R<w.length;R+=1)v[w[R]]=f[R];return v},a.prototype.getSQL=function(){return Ur(this.Qa)},a.prototype.getNormalizedSQL=function(){return Ls(this.Qa)},a.prototype.run=function(f){return f!=null&&this.bind(f),this.step(),this.reset()},a.prototype.sb=function(f,w){w==null&&(w=this.Oa,this.Oa+=1),f=gr(f);var v=It(f,Lt);this.lb.push(v),this.db.handleError(Is(this.Qa,w,v,f.length-1,0))},a.prototype.Bb=function(f,w){w==null&&(w=this.Oa,this.Oa+=1);var v=It(f,Lt);this.lb.push(v),this.db.handleError($r(this.Qa,w,v,f.length,0))},a.prototype.rb=function(f,w){w==null&&(w=this.Oa,this.Oa+=1),this.db.handleError((f===(f|0)?Ps:Ds)(this.Qa,w,f))},a.prototype.Eb=function(f){f==null&&(f=this.Oa,this.Oa+=1),$r(this.Qa,f,0,0,0)},a.prototype.tb=function(f,w){switch(w==null&&(w=this.Oa,this.Oa+=1),typeof f){case"string":this.sb(f,w);return;case"number":this.rb(f,w);return;case"bigint":this.sb(f.toString(),w);return;case"boolean":this.rb(f+0,w);return;case"object":if(f===null){this.Eb(w);return}if(f.length!=null){this.Bb(f,w);return}}throw"Wrong API use : tried to bind a value of an unknown type ("+f+")."},a.prototype.Db=function(f){var w=this;return Object.keys(f).forEach(function(v){var R=Fs(w.Qa,v);R!==0&&w.tb(f[v],R)}),!0},a.prototype.Cb=function(f){for(var w=0;w<f.length;w+=1)this.tb(f[w],w+1);return!0},a.prototype.reset=function(){return this.freemem(),Vs(this.Qa)===0&&zs(this.Qa)===0},a.prototype.freemem=function(){for(var f;(f=this.lb.pop())!==void 0;)Dt(f)},a.prototype.free=function(){this.freemem();var f=Gs(this.Qa)===0;return delete this.db.fb[this.Qa],this.Qa=0,f},l.prototype.next=function(){if(this.eb===null)return{done:!0};if(this.Za!==null&&(this.Za.free(),this.Za=null),!this.db.db)throw this.mb(),Error("Database closed");var f=at(),w=Ee(4);et(g),et(w);try{this.db.handleError(Wr(this.db.db,this.kb,-1,g,w)),this.kb=de(w,"i32");var v=de(g,"i32");return v===0?(this.mb(),{done:!0}):(this.Za=new a(v,this.db),this.db.fb[v]=this.Za,{value:this.Za,done:!1})}catch(R){throw this.pb=hn(this.kb),this.mb(),R}finally{st(f)}},l.prototype.mb=function(){Dt(this.eb),this.eb=null},l.prototype.getRemainingSQL=function(){return this.pb!==null?this.pb:hn(this.kb)},typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"&&(l.prototype[Symbol.iterator]=function(){return this}),u.prototype.run=function(f,w){if(!this.db)throw"Database closed";if(w){f=this.prepare(f,w);try{f.step()}finally{f.free()}}else this.handleError(N(this.db,f,0,0,g));return this},u.prototype.exec=function(f,w,v){if(!this.db)throw"Database closed";var R=at(),C=null;try{var F=Cn(f),ae=Ee(4);for(f=[];de(F,"i8")!==0;){et(g),et(ae),this.handleError(Wr(this.db,F,-1,g,ae));var ne=de(g,"i32");if(F=de(ae,"i32"),ne!==0){var ee=null;for(C=new a(ne,this),w!=null&&C.bind(w);C.step();)ee===null&&(ee={columns:C.getColumnNames(),values:[]},f.push(ee)),ee.values.push(C.get(null,v));C.free()}}return f}catch(oe){throw C&&C.free(),oe}finally{st(R)}},u.prototype.each=function(f,w,v,R,C){typeof w=="function"&&(R=v,v=w,w=void 0),f=this.prepare(f,w);try{for(;f.step();)v(f.getAsObject(null,C))}finally{f.free()}if(typeof R=="function")return R()},u.prototype.prepare=function(f,w){if(et(g),this.handleError(J(this.db,f,-1,g,0)),f=de(g,"i32"),f===0)throw"Nothing to prepare";var v=new a(f,this);return w!=null&&v.bind(w),this.fb[f]=v},u.prototype.iterateStatements=function(f){return new l(f,this)},u.prototype.export=function(){Object.values(this.fb).forEach(function(w){w.free()}),Object.values(this.Sa).forEach(ye),this.Sa={},this.handleError(I(this.db));var f=Ts(this.filename);return this.handleError(T(this.filename,g)),this.db=de(g,"i32"),Qr(this.db),f},u.prototype.close=function(){this.db!==null&&(Object.values(this.fb).forEach(function(f){f.free()}),Object.values(this.Sa).forEach(ye),this.Sa={},this.Ya&&(ye(this.Ya),this.Ya=void 0),this.handleError(I(this.db)),Lr("/"+this.filename),this.db=null)},u.prototype.handleError=function(f){if(f===0)return null;throw f=Ms(this.db),Error(f)},u.prototype.getRowsModified=function(){return $(this.db)},u.prototype.create_function=function(f,w){Object.prototype.hasOwnProperty.call(this.Sa,f)&&(ye(this.Sa[f]),delete this.Sa[f]);var v=it(function(R,C,F){C=r(C,F);try{var ae=w.apply(null,C)}catch(ne){Pt(R,ne,-1);return}t(R,ae)},"viii");return this.Sa[f]=v,this.handleError(zr(this.db,f,w.length,1,0,v,0,0,0)),this},u.prototype.create_aggregate=function(f,w){var v=w.init||function(){return null},R=w.finalize||function(ee){return ee},C=w.step;if(!C)throw"An aggregate function must have a step function in "+f;var F={};Object.hasOwnProperty.call(this.Sa,f)&&(ye(this.Sa[f]),delete this.Sa[f]),w=f+"__finalize",Object.hasOwnProperty.call(this.Sa,w)&&(ye(this.Sa[w]),delete this.Sa[w]);var ae=it(function(ee,oe,In){var Le=Gr(ee,1);Object.hasOwnProperty.call(F,Le)||(F[Le]=v()),oe=r(oe,In),oe=[F[Le]].concat(oe);try{F[Le]=C.apply(null,oe)}catch(na){delete F[Le],Pt(ee,na,-1)}},"viii"),ne=it(function(ee){var oe=Gr(ee,1);try{var In=R(F[oe])}catch(Le){delete F[oe],Pt(ee,Le,-1);return}t(ee,In),delete F[oe]},"vi");return this.Sa[f]=ae,this.Sa[w]=ne,this.handleError(zr(this.db,f,C.length-1,1,0,0,ae,ne,0)),this},u.prototype.updateHook=function(f){this.Ya&&(Yr(this.db,0,0),ye(this.Ya),this.Ya=void 0),f&&(this.Ya=it(function(w,v,R,C,F){switch(v){case 18:w="insert";break;case 23:w="update";break;case 9:w="delete";break;default:throw"unknown operationCode in updateHook callback: "+v}if(R=R?W(L,R):"",C=C?W(L,C):"",F>Number.MAX_SAFE_INTEGER)throw"rowId too big to fit inside a Number";f(w,R,C,Number(F))},"viiiij"),Yr(this.db,this.Ya,0))},s.Database=u};var y={...s},S="./this.program",D=(t,r)=>{throw r},_="",H,G;if(p){var Q=require("fs");require("path"),_=__dirname+"/",G=t=>(t=vt(t)?new URL(t):t,Q.readFileSync(t)),H=async t=>(t=vt(t)?new URL(t):t,Q.readFileSync(t,void 0)),!s.thisProgram&&1<process.argv.length&&(S=process.argv[1].replace(/\\/g,"/")),process.argv.slice(2),typeof Oe<"u"&&(Oe.exports=s),D=(t,r)=>{throw process.exitCode=t,r}}else(d||h)&&(h?_=self.location.href:typeof document<"u"&&document.currentScript&&(_=document.currentScript.src),_=_.startsWith("blob:")?"":_.slice(0,_.replace(/[?#].*/,"").lastIndexOf("/")+1),h&&(G=t=>{var r=new XMLHttpRequest;return r.open("GET",t,!1),r.responseType="arraybuffer",r.send(null),new Uint8Array(r.response)}),H=async t=>{if(vt(t))return new Promise((a,l)=>{var u=new XMLHttpRequest;u.open("GET",t,!0),u.responseType="arraybuffer",u.onload=()=>{u.status==200||u.status==0&&u.response?a(u.response):l(u.status)},u.onerror=l,u.send(null)});var r=await fetch(t,{credentials:"same-origin"});if(r.ok)return r.arrayBuffer();throw Error(r.status+" : "+r.url)});var Je=s.print||console.log.bind(console),le=s.printErr||console.error.bind(console);Object.assign(s,y),y=null,s.thisProgram&&(S=s.thisProgram);var qe=s.wasmBinary,me,Re=!1,Z,M,L,ue,O,z,ln,se,cn,vt=t=>t.startsWith("file://");function or(){var t=me.buffer;s.HEAP8=M=new Int8Array(t),s.HEAP16=ue=new Int16Array(t),s.HEAPU8=L=new Uint8Array(t),s.HEAPU16=new Uint16Array(t),s.HEAP32=O=new Int32Array(t),s.HEAPU32=z=new Uint32Array(t),s.HEAPF32=ln=new Float32Array(t),s.HEAPF64=cn=new Float64Array(t),s.HEAP64=se=new BigInt64Array(t),s.HEAPU64=new BigUint64Array(t)}var _e=0,Ze=null;function Ue(t){throw s.onAbort?.(t),t="Aborted("+t+")",le(t),Re=!0,new WebAssembly.RuntimeError(t+". Build with -sASSERTIONS for more info.")}var un;async function cs(t){if(!qe)try{var r=await H(t);return new Uint8Array(r)}catch{}if(t==un&&qe)t=new Uint8Array(qe);else if(G)t=G(t);else throw"both async and sync fetching of the wasm failed";return t}async function us(t,r){try{var a=await cs(t);return await WebAssembly.instantiate(a,r)}catch(l){le(`failed to asynchronously prepare wasm: ${l}`),Ue(l)}}async function ds(t){var r=un;if(!qe&&typeof WebAssembly.instantiateStreaming=="function"&&!vt(r)&&!p)try{var a=fetch(r,{credentials:"same-origin"});return await WebAssembly.instantiateStreaming(a,t)}catch(l){le(`wasm streaming compile failed: ${l}`),le("falling back to ArrayBuffer instantiation")}return us(r,t)}class dn{name="ExitStatus";constructor(r){this.message=`Program terminated with exit(${r})`,this.status=r}}var lr=t=>{for(;0<t.length;)t.shift()(s)},cr=[],ur=[],fs=()=>{var t=s.preRun.shift();ur.unshift(t)};function de(t,r="i8"){switch(r.endsWith("*")&&(r="*"),r){case"i1":return M[t];case"i8":return M[t];case"i16":return ue[t>>1];case"i32":return O[t>>2];case"i64":return se[t>>3];case"float":return ln[t>>2];case"double":return cn[t>>3];case"*":return z[t>>2];default:Ue(`invalid type for getValue: ${r}`)}}var fn=s.noExitRuntime||!0;function et(t){var r="i32";switch(r.endsWith("*")&&(r="*"),r){case"i1":M[t]=0;break;case"i8":M[t]=0;break;case"i16":ue[t>>1]=0;break;case"i32":O[t>>2]=0;break;case"i64":se[t>>3]=BigInt(0);break;case"float":ln[t>>2]=0;break;case"double":cn[t>>3]=0;break;case"*":z[t>>2]=0;break;default:Ue(`invalid type for setValue: ${r}`)}}var dr=typeof TextDecoder<"u"?new TextDecoder:void 0,W=(t,r=0,a=NaN)=>{var l=r+a;for(a=r;t[a]&&!(a>=l);)++a;if(16<a-r&&t.buffer&&dr)return dr.decode(t.subarray(r,a));for(l="";r<a;){var u=t[r++];if(u&128){var g=t[r++]&63;if((u&224)==192)l+=String.fromCharCode((u&31)<<6|g);else{var b=t[r++]&63;u=(u&240)==224?(u&15)<<12|g<<6|b:(u&7)<<18|g<<12|b<<6|t[r++]&63,65536>u?l+=String.fromCharCode(u):(u-=65536,l+=String.fromCharCode(55296|u>>10,56320|u&1023))}}else l+=String.fromCharCode(u)}return l},hn=(t,r)=>t?W(L,t,r):"",fr=(t,r)=>{for(var a=0,l=t.length-1;0<=l;l--){var u=t[l];u==="."?t.splice(l,1):u===".."?(t.splice(l,1),a++):a&&(t.splice(l,1),a--)}if(r)for(;a;a--)t.unshift("..");return t},pn=t=>{var r=t.charAt(0)==="/",a=t.slice(-1)==="/";return(t=fr(t.split("/").filter(l=>!!l),!r).join("/"))||r||(t="."),t&&a&&(t+="/"),(r?"/":"")+t},hr=t=>{var r=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(t).slice(1);return t=r[0],r=r[1],!t&&!r?".":(r&&=r.slice(0,-1),t+r)},St=t=>t&&t.match(/([^\/]+|\/)\/*$/)[1],hs=()=>{if(p){var t=require("crypto");return r=>t.randomFillSync(r)}return r=>crypto.getRandomValues(r)},pr=t=>{(pr=hs())(t)},ps=(...t)=>{for(var r="",a=!1,l=t.length-1;-1<=l&&!a;l--){if(a=0<=l?t[l]:"/",typeof a!="string")throw new TypeError("Arguments to path.resolve must be strings");if(!a)return"";r=a+"/"+r,a=a.charAt(0)==="/"}return r=fr(r.split("/").filter(u=>!!u),!a).join("/"),(a?"/":"")+r||"."},gn=[],tt=t=>{for(var r=0,a=0;a<t.length;++a){var l=t.charCodeAt(a);127>=l?r++:2047>=l?r+=2:55296<=l&&57343>=l?(r+=4,++a):r+=3}return r},fe=(t,r,a,l)=>{if(!(0<l))return 0;var u=a;l=a+l-1;for(var g=0;g<t.length;++g){var b=t.charCodeAt(g);if(55296<=b&&57343>=b){var T=t.charCodeAt(++g);b=65536+((b&1023)<<10)|T&1023}if(127>=b){if(a>=l)break;r[a++]=b}else{if(2047>=b){if(a+1>=l)break;r[a++]=192|b>>6}else{if(65535>=b){if(a+2>=l)break;r[a++]=224|b>>12}else{if(a+3>=l)break;r[a++]=240|b>>18,r[a++]=128|b>>12&63}r[a++]=128|b>>6&63}r[a++]=128|b&63}}return r[a]=0,a-u},gr=(t,r)=>{var a=Array(tt(t)+1);return t=fe(t,a,0,a.length),r&&(a.length=t),a},mr=[];function br(t,r){mr[t]={input:[],output:[],cb:r},vn(t,gs)}var gs={open(t){var r=mr[t.node.rdev];if(!r)throw new E(43);t.tty=r,t.seekable=!1},close(t){t.tty.cb.fsync(t.tty)},fsync(t){t.tty.cb.fsync(t.tty)},read(t,r,a,l){if(!t.tty||!t.tty.cb.xb)throw new E(60);for(var u=0,g=0;g<l;g++){try{var b=t.tty.cb.xb(t.tty)}catch{throw new E(29)}if(b===void 0&&u===0)throw new E(6);if(b==null)break;u++,r[a+g]=b}return u&&(t.node.atime=Date.now()),u},write(t,r,a,l){if(!t.tty||!t.tty.cb.qb)throw new E(60);try{for(var u=0;u<l;u++)t.tty.cb.qb(t.tty,r[a+u])}catch{throw new E(29)}return l&&(t.node.mtime=t.node.ctime=Date.now()),u}},ms={xb(){e:{if(!gn.length){var t=null;if(p){var r=Buffer.alloc(256),a=0,l=process.stdin.fd;try{a=Q.readSync(l,r,0,256)}catch(u){if(u.toString().includes("EOF"))a=0;else throw u}0<a&&(t=r.slice(0,a).toString("utf-8"))}else typeof window<"u"&&typeof window.prompt=="function"&&(t=window.prompt("Input: "),t!==null&&(t+=`
`));if(!t){t=null;break e}gn=gr(t,!0)}t=gn.shift()}return t},qb(t,r){r===null||r===10?(Je(W(t.output)),t.output=[]):r!=0&&t.output.push(r)},fsync(t){0<t.output?.length&&(Je(W(t.output)),t.output=[])},Tb(){return{Ob:25856,Qb:5,Nb:191,Pb:35387,Mb:[3,28,127,21,4,0,1,0,17,19,26,0,18,15,23,22,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}},Ub(){return 0},Vb(){return[24,80]}},bs={qb(t,r){r===null||r===10?(le(W(t.output)),t.output=[]):r!=0&&t.output.push(r)},fsync(t){0<t.output?.length&&(le(W(t.output)),t.output=[])}},x={Wa:null,Xa(){return x.createNode(null,"/",16895,0)},createNode(t,r,a,l){if((a&61440)===24576||(a&61440)===4096)throw new E(63);return x.Wa||(x.Wa={dir:{node:{Ta:x.La.Ta,Ua:x.La.Ua,lookup:x.La.lookup,hb:x.La.hb,rename:x.La.rename,unlink:x.La.unlink,rmdir:x.La.rmdir,readdir:x.La.readdir,symlink:x.La.symlink},stream:{Va:x.Ma.Va}},file:{node:{Ta:x.La.Ta,Ua:x.La.Ua},stream:{Va:x.Ma.Va,read:x.Ma.read,write:x.Ma.write,ib:x.Ma.ib,jb:x.Ma.jb}},link:{node:{Ta:x.La.Ta,Ua:x.La.Ua,readlink:x.La.readlink},stream:{}},ub:{node:{Ta:x.La.Ta,Ua:x.La.Ua},stream:Ss}}),a=Ar(t,r,a,l),X(a.mode)?(a.La=x.Wa.dir.node,a.Ma=x.Wa.dir.stream,a.Na={}):(a.mode&61440)===32768?(a.La=x.Wa.file.node,a.Ma=x.Wa.file.stream,a.Ra=0,a.Na=null):(a.mode&61440)===40960?(a.La=x.Wa.link.node,a.Ma=x.Wa.link.stream):(a.mode&61440)===8192&&(a.La=x.Wa.ub.node,a.Ma=x.Wa.ub.stream),a.atime=a.mtime=a.ctime=Date.now(),t&&(t.Na[r]=a,t.atime=t.mtime=t.ctime=a.atime),a},Sb(t){return t.Na?t.Na.subarray?t.Na.subarray(0,t.Ra):new Uint8Array(t.Na):new Uint8Array(0)},La:{Ta(t){var r={};return r.dev=(t.mode&61440)===8192?t.id:1,r.ino=t.id,r.mode=t.mode,r.nlink=1,r.uid=0,r.gid=0,r.rdev=t.rdev,X(t.mode)?r.size=4096:(t.mode&61440)===32768?r.size=t.Ra:(t.mode&61440)===40960?r.size=t.link.length:r.size=0,r.atime=new Date(t.atime),r.mtime=new Date(t.mtime),r.ctime=new Date(t.ctime),r.blksize=4096,r.blocks=Math.ceil(r.size/r.blksize),r},Ua(t,r){for(var a of["mode","atime","mtime","ctime"])r[a]!=null&&(t[a]=r[a]);r.size!==void 0&&(r=r.size,t.Ra!=r&&(r==0?(t.Na=null,t.Ra=0):(a=t.Na,t.Na=new Uint8Array(r),a&&t.Na.set(a.subarray(0,Math.min(r,t.Ra))),t.Ra=r)))},lookup(){throw x.vb},hb(t,r,a,l){return x.createNode(t,r,a,l)},rename(t,r,a){try{var l=Ce(r,a)}catch{}if(l){if(X(t.mode))for(var u in l.Na)throw new E(55);yn(l)}delete t.parent.Na[t.name],r.Na[a]=t,t.name=a,r.ctime=r.mtime=t.parent.ctime=t.parent.mtime=Date.now()},unlink(t,r){delete t.Na[r],t.ctime=t.mtime=Date.now()},rmdir(t,r){var a=Ce(t,r),l;for(l in a.Na)throw new E(55);delete t.Na[r],t.ctime=t.mtime=Date.now()},readdir(t){return[".","..",...Object.keys(t.Na)]},symlink(t,r,a){return t=x.createNode(t,r,41471,0),t.link=a,t},readlink(t){if((t.mode&61440)!==40960)throw new E(28);return t.link}},Ma:{read(t,r,a,l,u){var g=t.node.Na;if(u>=t.node.Ra)return 0;if(t=Math.min(t.node.Ra-u,l),8<t&&g.subarray)r.set(g.subarray(u,u+t),a);else for(l=0;l<t;l++)r[a+l]=g[u+l];return t},write(t,r,a,l,u,g){if(r.buffer===M.buffer&&(g=!1),!l)return 0;if(t=t.node,t.mtime=t.ctime=Date.now(),r.subarray&&(!t.Na||t.Na.subarray)){if(g)return t.Na=r.subarray(a,a+l),t.Ra=l;if(t.Ra===0&&u===0)return t.Na=r.slice(a,a+l),t.Ra=l;if(u+l<=t.Ra)return t.Na.set(r.subarray(a,a+l),u),l}g=u+l;var b=t.Na?t.Na.length:0;if(b>=g||(g=Math.max(g,b*(1048576>b?2:1.125)>>>0),b!=0&&(g=Math.max(g,256)),b=t.Na,t.Na=new Uint8Array(g),0<t.Ra&&t.Na.set(b.subarray(0,t.Ra),0)),t.Na.subarray&&r.subarray)t.Na.set(r.subarray(a,a+l),u);else for(g=0;g<l;g++)t.Na[u+g]=r[a+g];return t.Ra=Math.max(t.Ra,u+l),l},Va(t,r,a){if(a===1?r+=t.position:a===2&&(t.node.mode&61440)===32768&&(r+=t.node.Ra),0>r)throw new E(28);return r},ib(t,r,a,l,u){if((t.node.mode&61440)!==32768)throw new E(43);if(t=t.node.Na,u&2||!t||t.buffer!==M.buffer){u=!0,l=65536*Math.ceil(r/65536);var g=Or(65536,l);if(g&&L.fill(0,g,g+l),l=g,!l)throw new E(48);t&&((0<a||a+r<t.length)&&(t.subarray?t=t.subarray(a,a+r):t=Array.prototype.slice.call(t,a,a+r)),M.set(t,l))}else u=!1,l=t.byteOffset;return{Kb:l,Ab:u}},jb(t,r,a,l){return x.Ma.write(t,r,0,l,a,!1),0}}},wr=(t,r)=>{var a=0;return t&&(a|=365),r&&(a|=146),a},mn=null,yr={},We=[],ws=1,be=null,Er=!1,vr=!0,Sr={},E=class{name="ErrnoError";constructor(t){this.Pa=t}},ys=class{gb={};node=null;get flags(){return this.gb.flags}set flags(t){this.gb.flags=t}get position(){return this.gb.position}set position(t){this.gb.position=t}},Es=class{La={};Ma={};ab=null;constructor(t,r,a,l){t||=this,this.parent=t,this.Xa=t.Xa,this.id=ws++,this.name=r,this.mode=a,this.rdev=l,this.atime=this.mtime=this.ctime=Date.now()}get read(){return(this.mode&365)===365}set read(t){t?this.mode|=365:this.mode&=-366}get write(){return(this.mode&146)===146}set write(t){t?this.mode|=146:this.mode&=-147}};function te(t,r={}){if(!t)throw new E(44);r.nb??(r.nb=!0),t.charAt(0)==="/"||(t="//"+t);var a=0;e:for(;40>a;a++){t=t.split("/").filter(T=>!!T);for(var l=mn,u="/",g=0;g<t.length;g++){var b=g===t.length-1;if(b&&r.parent)break;if(t[g]!==".")if(t[g]==="..")u=hr(u),l=l.parent;else{u=pn(u+"/"+t[g]);try{l=Ce(l,t[g])}catch(T){if(T?.Pa===44&&b&&r.Jb)return{path:u};throw T}if(!l.ab||b&&!r.nb||(l=l.ab.root),(l.mode&61440)===40960&&(!b||r.$a)){if(!l.La.readlink)throw new E(52);l=l.La.readlink(l),l.charAt(0)==="/"||(l=hr(u)+"/"+l),t=l+"/"+t.slice(g+1).join("/");continue e}}}return{path:u,node:l}}throw new E(32)}function bn(t){for(var r;;){if(t===t.parent)return t=t.Xa.zb,r?t[t.length-1]!=="/"?`${t}/${r}`:t+r:t;r=r?`${t.name}/${r}`:t.name,t=t.parent}}function wn(t,r){for(var a=0,l=0;l<r.length;l++)a=(a<<5)-a+r.charCodeAt(l)|0;return(t+a>>>0)%be.length}function yn(t){var r=wn(t.parent.id,t.name);if(be[r]===t)be[r]=t.bb;else for(r=be[r];r;){if(r.bb===t){r.bb=t.bb;break}r=r.bb}}function Ce(t,r){var a=X(t.mode)?(a=$e(t,"x"))?a:t.La.lookup?0:2:54;if(a)throw new E(a);for(a=be[wn(t.id,r)];a;a=a.bb){var l=a.name;if(a.parent.id===t.id&&l===r)return a}return t.La.lookup(t,r)}function Ar(t,r,a,l){return t=new Es(t,r,a,l),r=wn(t.parent.id,t.name),t.bb=be[r],be[r]=t}function X(t){return(t&61440)===16384}function Tr(t){var r=["r","w","rw"][t&3];return t&512&&(r+="w"),r}function $e(t,r){if(vr)return 0;if(!r.includes("r")||t.mode&292){if(r.includes("w")&&!(t.mode&146)||r.includes("x")&&!(t.mode&73))return 2}else return 2;return 0}function Rr(t,r){if(!X(t.mode))return 54;try{return Ce(t,r),20}catch{}return $e(t,"wx")}function _r(t,r,a){try{var l=Ce(t,r)}catch(u){return u.Pa}if(t=$e(t,"wx"))return t;if(a){if(!X(l.mode))return 54;if(l===l.parent||bn(l)==="/")return 10}else if(X(l.mode))return 31;return 0}function At(t){if(!t)throw new E(63);return t}function j(t){if(t=We[t],!t)throw new E(8);return t}function Cr(t,r=-1){if(t=Object.assign(new ys,t),r==-1)e:{for(r=0;4096>=r;r++)if(!We[r])break e;throw new E(33)}return t.fd=r,We[r]=t}function vs(t,r=-1){return t=Cr(t,r),t.Ma?.Rb?.(t),t}function En(t,r,a){var l=t?.Ma.Ua;t=l?t:r,l??=r.La.Ua,At(l),l(t,a)}var Ss={open(t){t.Ma=yr[t.node.rdev].Ma,t.Ma.open?.(t)},Va(){throw new E(70)}};function vn(t,r){yr[t]={Ma:r}}function xr(t,r){var a=r==="/";if(a&&mn)throw new E(10);if(!a&&r){var l=te(r,{nb:!1});if(r=l.path,l=l.node,l.ab)throw new E(10);if(!X(l.mode))throw new E(54)}r={type:t,Wb:{},zb:r,Ib:[]},t=t.Xa(r),t.Xa=r,r.root=t,a?mn=t:l&&(l.ab=r,l.Xa&&l.Xa.Ib.push(r))}function Tt(t,r,a){var l=te(t,{parent:!0}).node;if(t=St(t),!t)throw new E(28);if(t==="."||t==="..")throw new E(20);var u=Rr(l,t);if(u)throw new E(u);if(!l.La.hb)throw new E(63);return l.La.hb(l,t,r,a)}function As(t,r=438){return Tt(t,r&4095|32768,0)}function ce(t,r=511){return Tt(t,r&1023|16384,0)}function Rt(t,r,a){typeof a>"u"&&(a=r,r=438),Tt(t,r|8192,a)}function Sn(t,r){if(!ps(t))throw new E(44);var a=te(r,{parent:!0}).node;if(!a)throw new E(44);r=St(r);var l=Rr(a,r);if(l)throw new E(l);if(!a.La.symlink)throw new E(63);a.La.symlink(a,r,t)}function Nr(t){var r=te(t,{parent:!0}).node;t=St(t);var a=Ce(r,t),l=_r(r,t,!0);if(l)throw new E(l);if(!r.La.rmdir)throw new E(63);if(a.ab)throw new E(10);r.La.rmdir(r,t),yn(a)}function Lr(t){var r=te(t,{parent:!0}).node;if(!r)throw new E(44);t=St(t);var a=Ce(r,t),l=_r(r,t,!1);if(l)throw new E(l);if(!r.La.unlink)throw new E(63);if(a.ab)throw new E(10);r.La.unlink(r,t),yn(a)}function nt(t,r){return t=te(t,{$a:!r}).node,At(t.La.Ta)(t)}function Ir(t,r,a,l){En(t,r,{mode:a&4095|r.mode&-4096,ctime:Date.now(),Fb:l})}function _t(t,r){t=typeof t=="string"?te(t,{$a:!0}).node:t,Ir(null,t,r)}function Dr(t,r,a){if(X(r.mode))throw new E(31);if((r.mode&61440)!==32768)throw new E(28);var l=$e(r,"w");if(l)throw new E(l);En(t,r,{size:a,timestamp:Date.now()})}function He(t,r,a=438){if(t==="")throw new E(44);if(typeof r=="string"){var l={r:0,"r+":2,w:577,"w+":578,a:1089,"a+":1090}[r];if(typeof l>"u")throw Error(`Unknown file open mode: ${r}`);r=l}if(a=r&64?a&4095|32768:0,typeof t=="object")l=t;else{var u=t.endsWith("/");t=te(t,{$a:!(r&131072),Jb:!0}),l=t.node,t=t.path}var g=!1;if(r&64)if(l){if(r&128)throw new E(20)}else{if(u)throw new E(31);l=Tt(t,a|511,0),g=!0}if(!l)throw new E(44);if((l.mode&61440)===8192&&(r&=-513),r&65536&&!X(l.mode))throw new E(54);if(!g&&(u=l?(l.mode&61440)===40960?32:X(l.mode)&&(Tr(r)!=="r"||r&576)?31:$e(l,Tr(r)):44))throw new E(u);return r&512&&!g&&(u=l,u=typeof u=="string"?te(u,{$a:!0}).node:u,Dr(null,u,0)),r&=-131713,u=Cr({node:l,path:bn(l),flags:r,seekable:!0,position:0,Ma:l.Ma,Lb:[],error:!1}),u.Ma.open&&u.Ma.open(u),g&&_t(l,a&511),!s.logReadFiles||r&1||t in Sr||(Sr[t]=1),u}function An(t){if(t.fd===null)throw new E(8);t.ob&&(t.ob=null);try{t.Ma.close&&t.Ma.close(t)}catch(r){throw r}finally{We[t.fd]=null}t.fd=null}function Pr(t,r,a){if(t.fd===null)throw new E(8);if(!t.seekable||!t.Ma.Va)throw new E(70);if(a!=0&&a!=1&&a!=2)throw new E(28);t.position=t.Ma.Va(t,r,a),t.Lb=[]}function Fr(t,r,a,l,u){if(0>l||0>u)throw new E(28);if(t.fd===null)throw new E(8);if((t.flags&2097155)===1)throw new E(8);if(X(t.node.mode))throw new E(31);if(!t.Ma.read)throw new E(28);var g=typeof u<"u";if(!g)u=t.position;else if(!t.seekable)throw new E(70);return r=t.Ma.read(t,r,a,l,u),g||(t.position+=r),r}function kr(t,r,a,l,u){if(0>l||0>u)throw new E(28);if(t.fd===null)throw new E(8);if(!(t.flags&2097155))throw new E(8);if(X(t.node.mode))throw new E(31);if(!t.Ma.write)throw new E(28);t.seekable&&t.flags&1024&&Pr(t,0,2);var g=typeof u<"u";if(!g)u=t.position;else if(!t.seekable)throw new E(70);return r=t.Ma.write(t,r,a,l,u,void 0),g||(t.position+=r),r}function Ts(t){var r="binary";if(r!=="utf8"&&r!=="binary")throw Error(`Invalid encoding type "${r}"`);var a,l=He(t,l||0);t=nt(t).size;var u=new Uint8Array(t);return Fr(l,u,0,t,0),r==="utf8"?a=W(u):r==="binary"&&(a=u),An(l),a}function we(t,r,a){t=pn("/dev/"+t);var l=wr(!!r,!!a);we.yb??(we.yb=64);var u=we.yb++<<8|0;vn(u,{open(g){g.seekable=!1},close(){a?.buffer?.length&&a(10)},read(g,b,T,I){for(var N=0,$=0;$<I;$++){try{var J=r()}catch{throw new E(29)}if(J===void 0&&N===0)throw new E(6);if(J==null)break;N++,b[T+$]=J}return N&&(g.node.atime=Date.now()),N},write(g,b,T,I){for(var N=0;N<I;N++)try{a(b[T+N])}catch{throw new E(29)}return I&&(g.node.mtime=g.node.ctime=Date.now()),N}}),Rt(t,l,u)}var U={};function xe(t,r,a){if(r.charAt(0)==="/")return r;if(t=t===-100?"/":j(t).path,r.length==0){if(!a)throw new E(44);return t}return t+"/"+r}function Ct(t,r){O[t>>2]=r.dev,O[t+4>>2]=r.mode,z[t+8>>2]=r.nlink,O[t+12>>2]=r.uid,O[t+16>>2]=r.gid,O[t+20>>2]=r.rdev,se[t+24>>3]=BigInt(r.size),O[t+32>>2]=4096,O[t+36>>2]=r.blocks;var a=r.atime.getTime(),l=r.mtime.getTime(),u=r.ctime.getTime();return se[t+40>>3]=BigInt(Math.floor(a/1e3)),z[t+48>>2]=a%1e3*1e6,se[t+56>>3]=BigInt(Math.floor(l/1e3)),z[t+64>>2]=l%1e3*1e6,se[t+72>>3]=BigInt(Math.floor(u/1e3)),z[t+80>>2]=u%1e3*1e6,se[t+88>>3]=BigInt(r.ino),0}var xt=void 0,Nt=()=>{var t=O[+xt>>2];return xt+=4,t},Tn=0,Rs=[0,31,60,91,121,152,182,213,244,274,305,335],_s=[0,31,59,90,120,151,181,212,243,273,304,334],rt={},Mr=t=>{Z=t,fn||0<Tn||(s.onExit?.(t),Re=!0),D(t,new dn(t))},Cs=t=>{if(!Re)try{if(t(),!(fn||0<Tn))try{Z=t=Z,Mr(t)}catch(r){r instanceof dn||r=="unwind"||D(1,r)}}catch(r){r instanceof dn||r=="unwind"||D(1,r)}},Rn={},Br=()=>{if(!_n){var t={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:(typeof navigator=="object"&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:S||"./this.program"},r;for(r in Rn)Rn[r]===void 0?delete t[r]:t[r]=Rn[r];var a=[];for(r in t)a.push(`${r}=${t[r]}`);_n=a}return _n},_n,Cn=t=>{var r=tt(t)+1,a=Ee(r);return fe(t,L,a,r),a},xs=(t,r,a,l)=>{var u={string:N=>{var $=0;return N!=null&&N!==0&&($=Cn(N)),$},array:N=>{var $=Ee(N.length);return M.set(N,$),$}};t=s["_"+t];var g=[],b=0;if(l)for(var T=0;T<l.length;T++){var I=u[a[T]];I?(b===0&&(b=at()),g[T]=I(l[T])):g[T]=l[T]}return a=t(...g),a=function(N){return b!==0&&st(b),r==="string"?N?W(L,N):"":r==="boolean"?!!N:N}(a)},Lt=0,It=(t,r)=>(r=r==1?Ee(t.length):Nn(t.length),t.subarray||t.slice||(t=new Uint8Array(t)),L.set(t,r),r),Ne,xn=[],he,ye=t=>{Ne.delete(he.get(t)),he.set(t,null),xn.push(t)},it=(t,r)=>{if(!Ne){Ne=new WeakMap;var a=he.length;if(Ne)for(var l=0;l<0+a;l++){var u=he.get(l);u&&Ne.set(u,l)}}if(a=Ne.get(t)||0)return a;if(xn.length)a=xn.pop();else{try{he.grow(1)}catch(I){throw I instanceof RangeError?"Unable to grow wasm table. Set ALLOW_TABLE_GROWTH.":I}a=he.length-1}try{he.set(a,t)}catch(I){if(!(I instanceof TypeError))throw I;if(typeof WebAssembly.Function=="function"){var g=WebAssembly.Function;l={i:"i32",j:"i64",f:"f32",d:"f64",e:"externref",p:"i32"},u={parameters:[],results:r[0]=="v"?[]:[l[r[0]]]};for(var b=1;b<r.length;++b)u.parameters.push(l[r[b]]);r=new g(u,t)}else{l=[1],u=r.slice(0,1),r=r.slice(1),b={i:127,p:127,j:126,f:125,d:124,e:111},l.push(96);var T=r.length;128>T?l.push(T):l.push(T%128|128,T>>7);for(g of r)l.push(b[g]);u=="v"?l.push(0):l.push(1,b[u]),r=[0,97,115,109,1,0,0,0,1],g=l.length,128>g?r.push(g):r.push(g%128|128,g>>7),r.push(...l),r.push(2,7,1,1,101,1,102,0,0,7,5,1,1,102,0,0),r=new WebAssembly.Module(new Uint8Array(r)),r=new WebAssembly.Instance(r,{e:{f:t}}).exports.f}he.set(a,r)}return Ne.set(t,a),a};be=Array(4096),xr(x,"/"),ce("/tmp"),ce("/home"),ce("/home/web_user"),function(){ce("/dev"),vn(259,{read:()=>0,write:(l,u,g,b)=>b,Va:()=>0}),Rt("/dev/null",259),br(1280,ms),br(1536,bs),Rt("/dev/tty",1280),Rt("/dev/tty1",1536);var t=new Uint8Array(1024),r=0,a=()=>(r===0&&(pr(t),r=t.byteLength),t[--r]);we("random",a),we("urandom",a),ce("/dev/shm"),ce("/dev/shm/tmp")}(),function(){ce("/proc");var t=ce("/proc/self");ce("/proc/self/fd"),xr({Xa(){var r=Ar(t,"fd",16895,73);return r.Ma={Va:x.Ma.Va},r.La={lookup(a,l){a=+l;var u=j(a);return a={parent:null,Xa:{zb:"fake"},La:{readlink:()=>u.path},id:a+1},a.parent=a},readdir(){return Array.from(We.entries()).filter(([,a])=>a).map(([a])=>a.toString())}},r}},"/proc/self/fd")}(),x.vb=new E(44),x.vb.stack="<generic error, no stack>";var Ns={a:(t,r,a,l)=>Ue(`Assertion failed: ${t?W(L,t):""}, at: `+[r?r?W(L,r):"":"unknown filename",a,l?l?W(L,l):"":"unknown function"]),i:function(t,r){try{return t=t?W(L,t):"",_t(t,r),0}catch(a){if(typeof U>"u"||a.name!=="ErrnoError")throw a;return-a.Pa}},L:function(t,r,a){try{if(r=r?W(L,r):"",r=xe(t,r),a&-8)return-28;var l=te(r,{$a:!0}).node;return l?(t="",a&4&&(t+="r"),a&2&&(t+="w"),a&1&&(t+="x"),t&&$e(l,t)?-2:0):-44}catch(u){if(typeof U>"u"||u.name!=="ErrnoError")throw u;return-u.Pa}},j:function(t,r){try{var a=j(t);return Ir(a,a.node,r,!1),0}catch(l){if(typeof U>"u"||l.name!=="ErrnoError")throw l;return-l.Pa}},h:function(t){try{var r=j(t);return En(r,r.node,{timestamp:Date.now(),Fb:!1}),0}catch(a){if(typeof U>"u"||a.name!=="ErrnoError")throw a;return-a.Pa}},b:function(t,r,a){xt=a;try{var l=j(t);switch(r){case 0:var u=Nt();if(0>u)break;for(;We[u];)u++;return vs(l,u).fd;case 1:case 2:return 0;case 3:return l.flags;case 4:return u=Nt(),l.flags|=u,0;case 12:return u=Nt(),ue[u+0>>1]=2,0;case 13:case 14:return 0}return-28}catch(g){if(typeof U>"u"||g.name!=="ErrnoError")throw g;return-g.Pa}},g:function(t,r){try{var a=j(t),l=a.node,u=a.Ma.Ta;t=u?a:l,u??=l.La.Ta,At(u);var g=u(t);return Ct(r,g)}catch(b){if(typeof U>"u"||b.name!=="ErrnoError")throw b;return-b.Pa}},H:function(t,r){r=-9007199254740992>r||9007199254740992<r?NaN:Number(r);try{if(isNaN(r))return 61;var a=j(t);if(0>r||!(a.flags&2097155))throw new E(28);return Dr(a,a.node,r),0}catch(l){if(typeof U>"u"||l.name!=="ErrnoError")throw l;return-l.Pa}},G:function(t,r){try{if(r===0)return-28;var a=tt("/")+1;return r<a?-68:(fe("/",L,t,r),a)}catch(l){if(typeof U>"u"||l.name!=="ErrnoError")throw l;return-l.Pa}},K:function(t,r){try{return t=t?W(L,t):"",Ct(r,nt(t,!0))}catch(a){if(typeof U>"u"||a.name!=="ErrnoError")throw a;return-a.Pa}},C:function(t,r,a){try{return r=r?W(L,r):"",r=xe(t,r),ce(r,a),0}catch(l){if(typeof U>"u"||l.name!=="ErrnoError")throw l;return-l.Pa}},J:function(t,r,a,l){try{r=r?W(L,r):"";var u=l&256;return r=xe(t,r,l&4096),Ct(a,u?nt(r,!0):nt(r))}catch(g){if(typeof U>"u"||g.name!=="ErrnoError")throw g;return-g.Pa}},x:function(t,r,a,l){xt=l;try{r=r?W(L,r):"",r=xe(t,r);var u=l?Nt():0;return He(r,a,u).fd}catch(g){if(typeof U>"u"||g.name!=="ErrnoError")throw g;return-g.Pa}},v:function(t,r,a,l){try{if(r=r?W(L,r):"",r=xe(t,r),0>=l)return-28;var u=te(r).node;if(!u)throw new E(44);if(!u.La.readlink)throw new E(28);var g=u.La.readlink(u),b=Math.min(l,tt(g)),T=M[a+b];return fe(g,L,a,l+1),M[a+b]=T,b}catch(I){if(typeof U>"u"||I.name!=="ErrnoError")throw I;return-I.Pa}},u:function(t){try{return t=t?W(L,t):"",Nr(t),0}catch(r){if(typeof U>"u"||r.name!=="ErrnoError")throw r;return-r.Pa}},f:function(t,r){try{return t=t?W(L,t):"",Ct(r,nt(t))}catch(a){if(typeof U>"u"||a.name!=="ErrnoError")throw a;return-a.Pa}},r:function(t,r,a){try{return r=r?W(L,r):"",r=xe(t,r),a===0?Lr(r):a===512?Nr(r):Ue("Invalid flags passed to unlinkat"),0}catch(l){if(typeof U>"u"||l.name!=="ErrnoError")throw l;return-l.Pa}},q:function(t,r,a){try{r=r?W(L,r):"",r=xe(t,r,!0);var l=Date.now(),u,g;if(a){var b=z[a>>2]+4294967296*O[a+4>>2],T=O[a+8>>2];T==1073741823?u=l:T==1073741822?u=null:u=1e3*b+T/1e6,a+=16,b=z[a>>2]+4294967296*O[a+4>>2],T=O[a+8>>2],T==1073741823?g=l:T==1073741822?g=null:g=1e3*b+T/1e6}else g=u=l;if((g??u)!==null){t=u;var I=te(r,{$a:!0}).node;At(I.La.Ua)(I,{atime:t,mtime:g})}return 0}catch(N){if(typeof U>"u"||N.name!=="ErrnoError")throw N;return-N.Pa}},m:()=>Ue(""),l:()=>{fn=!1,Tn=0},A:function(t,r){t=-9007199254740992>t||9007199254740992<t?NaN:Number(t),t=new Date(1e3*t),O[r>>2]=t.getSeconds(),O[r+4>>2]=t.getMinutes(),O[r+8>>2]=t.getHours(),O[r+12>>2]=t.getDate(),O[r+16>>2]=t.getMonth(),O[r+20>>2]=t.getFullYear()-1900,O[r+24>>2]=t.getDay();var a=t.getFullYear();O[r+28>>2]=(a%4!==0||a%100===0&&a%400!==0?_s:Rs)[t.getMonth()]+t.getDate()-1|0,O[r+36>>2]=-(60*t.getTimezoneOffset()),a=new Date(t.getFullYear(),6,1).getTimezoneOffset();var l=new Date(t.getFullYear(),0,1).getTimezoneOffset();O[r+32>>2]=(a!=l&&t.getTimezoneOffset()==Math.min(l,a))|0},y:function(t,r,a,l,u,g,b){u=-9007199254740992>u||9007199254740992<u?NaN:Number(u);try{if(isNaN(u))return 61;var T=j(l);if(r&2&&!(a&2)&&(T.flags&2097155)!==2)throw new E(2);if((T.flags&2097155)===1)throw new E(2);if(!T.Ma.ib)throw new E(43);if(!t)throw new E(28);var I=T.Ma.ib(T,t,u,r,a),N=I.Kb;return O[g>>2]=I.Ab,z[b>>2]=N,0}catch($){if(typeof U>"u"||$.name!=="ErrnoError")throw $;return-$.Pa}},z:function(t,r,a,l,u,g){g=-9007199254740992>g||9007199254740992<g?NaN:Number(g);try{var b=j(u);if(a&2){if(a=g,(b.node.mode&61440)!==32768)throw new E(43);if(!(l&2)){var T=L.slice(t,t+r);b.Ma.jb&&b.Ma.jb(b,T,a,r,l)}}}catch(I){if(typeof U>"u"||I.name!=="ErrnoError")throw I;return-I.Pa}},n:(t,r)=>{if(rt[t]&&(clearTimeout(rt[t].id),delete rt[t]),!r)return 0;var a=setTimeout(()=>{delete rt[t],Cs(()=>qr(t,performance.now()))},r);return rt[t]={id:a,Xb:r},0},B:(t,r,a,l)=>{var u=new Date().getFullYear(),g=new Date(u,0,1).getTimezoneOffset();u=new Date(u,6,1).getTimezoneOffset(),z[t>>2]=60*Math.max(g,u),O[r>>2]=+(g!=u),r=b=>{var T=Math.abs(b);return`UTC${0<=b?"-":"+"}${String(Math.floor(T/60)).padStart(2,"0")}${String(T%60).padStart(2,"0")}`},t=r(g),r=r(u),u<g?(fe(t,L,a,17),fe(r,L,l,17)):(fe(t,L,l,17),fe(r,L,a,17))},d:()=>Date.now(),s:()=>2147483648,c:()=>performance.now(),o:t=>{var r=L.length;if(t>>>=0,2147483648<t)return!1;for(var a=1;4>=a;a*=2){var l=r*(1+.2/a);l=Math.min(l,t+100663296);e:{l=(Math.min(2147483648,65536*Math.ceil(Math.max(t,l)/65536))-me.buffer.byteLength+65535)/65536|0;try{me.grow(l),or();var u=1;break e}catch{}u=void 0}if(u)return!0}return!1},E:(t,r)=>{var a=0;return Br().forEach((l,u)=>{var g=r+a;for(u=z[t+4*u>>2]=g,g=0;g<l.length;++g)M[u++]=l.charCodeAt(g);M[u]=0,a+=l.length+1}),0},F:(t,r)=>{var a=Br();z[t>>2]=a.length;var l=0;return a.forEach(u=>l+=u.length+1),z[r>>2]=l,0},e:function(t){try{var r=j(t);return An(r),0}catch(a){if(typeof U>"u"||a.name!=="ErrnoError")throw a;return a.Pa}},p:function(t,r){try{var a=j(t);return M[r]=a.tty?2:X(a.mode)?3:(a.mode&61440)===40960?7:4,ue[r+2>>1]=0,se[r+8>>3]=BigInt(0),se[r+16>>3]=BigInt(0),0}catch(l){if(typeof U>"u"||l.name!=="ErrnoError")throw l;return l.Pa}},w:function(t,r,a,l){try{e:{var u=j(t);t=r;for(var g,b=r=0;b<a;b++){var T=z[t>>2],I=z[t+4>>2];t+=8;var N=Fr(u,M,T,I,g);if(0>N){var $=-1;break e}if(r+=N,N<I)break;typeof g<"u"&&(g+=N)}$=r}return z[l>>2]=$,0}catch(J){if(typeof U>"u"||J.name!=="ErrnoError")throw J;return J.Pa}},D:function(t,r,a,l){r=-9007199254740992>r||9007199254740992<r?NaN:Number(r);try{if(isNaN(r))return 61;var u=j(t);return Pr(u,r,a),se[l>>3]=BigInt(u.position),u.ob&&r===0&&a===0&&(u.ob=null),0}catch(g){if(typeof U>"u"||g.name!=="ErrnoError")throw g;return g.Pa}},I:function(t){try{var r=j(t);return r.Ma?.fsync?r.Ma.fsync(r):0}catch(a){if(typeof U>"u"||a.name!=="ErrnoError")throw a;return a.Pa}},t:function(t,r,a,l){try{e:{var u=j(t);t=r;for(var g,b=r=0;b<a;b++){var T=z[t>>2],I=z[t+4>>2];t+=8;var N=kr(u,M,T,I,g);if(0>N){var $=-1;break e}if(r+=N,N<I)break;typeof g<"u"&&(g+=N)}$=r}return z[l>>2]=$,0}catch(J){if(typeof U>"u"||J.name!=="ErrnoError")throw J;return J.Pa}},k:Mr},A;(async function(){function t(a){return A=a.exports,me=A.M,or(),he=A.O,_e--,s.monitorRunDependencies?.(_e),_e==0&&Ze&&(a=Ze,Ze=null,a()),A}_e++,s.monitorRunDependencies?.(_e);var r={a:Ns};return s.instantiateWasm?new Promise(a=>{s.instantiateWasm(r,(l,u)=>{t(l,u),a(l.exports)})}):(un??=s.locateFile?s.locateFile("sql-wasm.wasm",_):_+"sql-wasm.wasm",t((await ds(r)).instance))})(),s._sqlite3_free=t=>(s._sqlite3_free=A.P)(t),s._sqlite3_value_text=t=>(s._sqlite3_value_text=A.Q)(t),s._sqlite3_prepare_v2=(t,r,a,l,u)=>(s._sqlite3_prepare_v2=A.R)(t,r,a,l,u),s._sqlite3_step=t=>(s._sqlite3_step=A.S)(t),s._sqlite3_reset=t=>(s._sqlite3_reset=A.T)(t),s._sqlite3_exec=(t,r,a,l,u)=>(s._sqlite3_exec=A.U)(t,r,a,l,u),s._sqlite3_finalize=t=>(s._sqlite3_finalize=A.V)(t),s._sqlite3_column_name=(t,r)=>(s._sqlite3_column_name=A.W)(t,r),s._sqlite3_column_text=(t,r)=>(s._sqlite3_column_text=A.X)(t,r),s._sqlite3_column_type=(t,r)=>(s._sqlite3_column_type=A.Y)(t,r),s._sqlite3_errmsg=t=>(s._sqlite3_errmsg=A.Z)(t),s._sqlite3_clear_bindings=t=>(s._sqlite3_clear_bindings=A._)(t),s._sqlite3_value_blob=t=>(s._sqlite3_value_blob=A.$)(t),s._sqlite3_value_bytes=t=>(s._sqlite3_value_bytes=A.aa)(t),s._sqlite3_value_double=t=>(s._sqlite3_value_double=A.ba)(t),s._sqlite3_value_int=t=>(s._sqlite3_value_int=A.ca)(t),s._sqlite3_value_type=t=>(s._sqlite3_value_type=A.da)(t),s._sqlite3_result_blob=(t,r,a,l)=>(s._sqlite3_result_blob=A.ea)(t,r,a,l),s._sqlite3_result_double=(t,r)=>(s._sqlite3_result_double=A.fa)(t,r),s._sqlite3_result_error=(t,r,a)=>(s._sqlite3_result_error=A.ga)(t,r,a),s._sqlite3_result_int=(t,r)=>(s._sqlite3_result_int=A.ha)(t,r),s._sqlite3_result_int64=(t,r)=>(s._sqlite3_result_int64=A.ia)(t,r),s._sqlite3_result_null=t=>(s._sqlite3_result_null=A.ja)(t),s._sqlite3_result_text=(t,r,a,l)=>(s._sqlite3_result_text=A.ka)(t,r,a,l),s._sqlite3_aggregate_context=(t,r)=>(s._sqlite3_aggregate_context=A.la)(t,r),s._sqlite3_column_count=t=>(s._sqlite3_column_count=A.ma)(t),s._sqlite3_data_count=t=>(s._sqlite3_data_count=A.na)(t),s._sqlite3_column_blob=(t,r)=>(s._sqlite3_column_blob=A.oa)(t,r),s._sqlite3_column_bytes=(t,r)=>(s._sqlite3_column_bytes=A.pa)(t,r),s._sqlite3_column_double=(t,r)=>(s._sqlite3_column_double=A.qa)(t,r),s._sqlite3_bind_blob=(t,r,a,l,u)=>(s._sqlite3_bind_blob=A.ra)(t,r,a,l,u),s._sqlite3_bind_double=(t,r,a)=>(s._sqlite3_bind_double=A.sa)(t,r,a),s._sqlite3_bind_int=(t,r,a)=>(s._sqlite3_bind_int=A.ta)(t,r,a),s._sqlite3_bind_text=(t,r,a,l,u)=>(s._sqlite3_bind_text=A.ua)(t,r,a,l,u),s._sqlite3_bind_parameter_index=(t,r)=>(s._sqlite3_bind_parameter_index=A.va)(t,r),s._sqlite3_sql=t=>(s._sqlite3_sql=A.wa)(t),s._sqlite3_normalized_sql=t=>(s._sqlite3_normalized_sql=A.xa)(t),s._sqlite3_changes=t=>(s._sqlite3_changes=A.ya)(t),s._sqlite3_close_v2=t=>(s._sqlite3_close_v2=A.za)(t),s._sqlite3_create_function_v2=(t,r,a,l,u,g,b,T,I)=>(s._sqlite3_create_function_v2=A.Aa)(t,r,a,l,u,g,b,T,I),s._sqlite3_update_hook=(t,r,a)=>(s._sqlite3_update_hook=A.Ba)(t,r,a),s._sqlite3_open=(t,r)=>(s._sqlite3_open=A.Ca)(t,r);var Nn=s._malloc=t=>(Nn=s._malloc=A.Da)(t),Dt=s._free=t=>(Dt=s._free=A.Ea)(t);s._RegisterExtensionFunctions=t=>(s._RegisterExtensionFunctions=A.Fa)(t);var Or=(t,r)=>(Or=A.Ga)(t,r),qr=(t,r)=>(qr=A.Ha)(t,r),st=t=>(st=A.Ia)(t),Ee=t=>(Ee=A.Ja)(t),at=()=>(at=A.Ka)();s.stackSave=()=>at(),s.stackRestore=t=>st(t),s.stackAlloc=t=>Ee(t),s.cwrap=(t,r,a,l)=>{var u=!a||a.every(g=>g==="number"||g==="boolean");return r!=="string"&&u&&!l?s["_"+t]:(...g)=>xs(t,r,a,g)},s.addFunction=it,s.removeFunction=ye,s.UTF8ToString=hn,s.ALLOC_NORMAL=Lt,s.allocate=It,s.allocateUTF8OnStack=Cn;function Ln(){function t(){if(s.calledRun=!0,!Re){if(!s.noFSInit&&!Er){var r,a;Er=!0,l??=s.stdin,r??=s.stdout,a??=s.stderr,l?we("stdin",l):Sn("/dev/tty","/dev/stdin"),r?we("stdout",null,r):Sn("/dev/tty","/dev/stdout"),a?we("stderr",null,a):Sn("/dev/tty1","/dev/stderr"),He("/dev/stdin",0),He("/dev/stdout",1),He("/dev/stderr",1)}if(A.N(),vr=!1,s.onRuntimeInitialized?.(),s.postRun)for(typeof s.postRun=="function"&&(s.postRun=[s.postRun]);s.postRun.length;){var l=s.postRun.shift();cr.unshift(l)}lr(cr)}}if(0<_e)Ze=Ln;else{if(s.preRun)for(typeof s.preRun=="function"&&(s.preRun=[s.preRun]);s.preRun.length;)fs();lr(ur),0<_e?Ze=Ln:s.setStatus?(s.setStatus("Running..."),setTimeout(()=>{setTimeout(()=>s.setStatus(""),1),t()},1)):t()}}if(s.preInit)for(typeof s.preInit=="function"&&(s.preInit=[s.preInit]);0<s.preInit.length;)s.preInit.pop()();return Ln(),i}),Kt)};typeof Jt=="object"&&typeof Oe=="object"?(Oe.exports=Xt,Oe.exports.default=Xt):typeof define=="function"&&define.amd?define([],function(){return Xt}):typeof Jt=="object"&&(Jt.Module=Xt)});var io={};Pn(io,{default:()=>on});module.exports=la(io);var Et=require("obsidian");var B=require("obsidian");var Xr={databasePath:".obsidian/plugins/wewe-rss/data.db",syncSchedule:"35 5,17 * * *",autoSync:!0,syncInterval:60,updateDelay:60,maxArticlesPerFeed:100,articleRetentionDays:30,lastCleanupRetentionDays:30,noteFolder:"WeWe RSS",noteLocation:"WeWe RSS",noteTemplate:`---
title: {{title}}
url: {{url}}
published: {{publishedAt}}
feed: {{feedName}}
tags: [wewe-rss, {{feedName}}]
---

# {{title}}

> Published: {{publishedAt}}
> Source: [{{feedName}}]({{url}})

{{content}}
`,addTags:!0,titleIncludePatterns:[],titleExcludePatterns:[],platformUrl:"https://weread.111965.xyz",maxRequestsPerMinute:60,feedMode:"summary",enableCleanHtml:!1};var Yt=class extends B.PluginSettingTab{plugin;constructor(e,n){super(e,n),this.plugin=n}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"WeWe RSS Settings"}),e.createEl("div",{cls:"wewe-rss-settings-banner"}).createEl("p",{text:"Subscribe to WeChat public accounts and sync articles as Obsidian notes.",cls:"wewe-rss-settings-description"}),this.addAccountManagement(e),this.addSyncSettings(e),this.addNoteSettings(e),this.addContentSettings(e),this.addTitleFilteringSettings(e),this.addApiSettings(e),this.addAdvancedSettings(e)}addSyncSettings(e){e.createEl("h3",{text:"Sync Settings"}),new B.Setting(e).setName("Auto Sync").setDesc("Automatically sync feeds on schedule").addToggle(n=>n.setValue(this.plugin.settings.autoSync).onChange(async i=>{this.plugin.settings.autoSync=i,await this.plugin.saveSettings(),i?this.plugin.taskScheduler.registerTask("auto-sync",async()=>{await this.plugin.syncService.syncAll({staleThresholdHours:this.plugin.settings.syncInterval/60})},this.plugin.settings.syncInterval):this.plugin.taskScheduler.unregisterTask("auto-sync"),new B.Notice(`Auto-sync ${i?"enabled":"disabled"}`)})),new B.Setting(e).setName("Sync Interval").setDesc("How often to sync feeds (in minutes)").addSlider(n=>n.setLimits(15,360,15).setValue(this.plugin.settings.syncInterval).setDynamicTooltip().onChange(async i=>{this.plugin.settings.syncInterval=i,await this.plugin.saveSettings(),this.plugin.settings.autoSync&&this.plugin.taskScheduler.updateTaskInterval("auto-sync",i)})),new B.Setting(e).setName("Update Delay").setDesc("Delay between feed requests (seconds) - prevents rate limiting").addSlider(n=>n.setLimits(10,300,10).setValue(this.plugin.settings.updateDelay).setDynamicTooltip().onChange(async i=>{this.plugin.settings.updateDelay=i,await this.plugin.saveSettings()})),new B.Setting(e).setName("Max Articles Per Feed").setDesc("Maximum number of articles to fetch per feed").addSlider(n=>n.setLimits(10,500,10).setValue(this.plugin.settings.maxArticlesPerFeed).setDynamicTooltip().onChange(async i=>{this.plugin.settings.maxArticlesPerFeed=i,await this.plugin.saveSettings()}))}addNoteSettings(e){e.createEl("h3",{text:"Note Settings"}),new B.Setting(e).setName("Note Folder").setDesc("Folder where article notes will be created").addText(n=>n.setPlaceholder("WeWe RSS").setValue(this.plugin.settings.noteFolder).onChange(async i=>{this.plugin.settings.noteFolder=i,this.plugin.settings.noteLocation=i,await this.plugin.saveSettings()})),new B.Setting(e).setName("Add Tags").setDesc("Automatically add tags to created notes").addToggle(n=>n.setValue(this.plugin.settings.addTags).onChange(async i=>{this.plugin.settings.addTags=i,await this.plugin.saveSettings()})),new B.Setting(e).setName("Note Template").setDesc("Template for created notes. Available variables: {{title}}, {{feedName}}, {{url}}, {{publishedAt}}, {{content}}, {{tags}}, {{date}}").addTextArea(n=>{n.setPlaceholder("Enter your note template...").setValue(this.plugin.settings.noteTemplate).onChange(async i=>{this.plugin.settings.noteTemplate=i,await this.plugin.saveSettings()}),n.inputEl.rows=12,n.inputEl.cols=50}),new B.Setting(e).setName("Reset Template").setDesc("Reset note template to default").addButton(n=>n.setButtonText("Reset to Default").onClick(async()=>{let i=`---
title: {{title}}
url: {{url}}
published: {{publishedAt}}
feed: {{feedName}}
tags: [wewe-rss, {{feedName}}]
---

# {{title}}

> Published: {{publishedAt}}
> Source: [{{feedName}}]({{url}})

{{content}}
`;this.plugin.settings.noteTemplate=i,await this.plugin.saveSettings(),this.display(),new B.Notice("Template reset to default")}))}addContentSettings(e){e.createEl("h3",{text:"Content Settings"}),new B.Setting(e).setName("Feed Mode").setDesc("Summary (faster) or Full Text (slower, more content)").addDropdown(n=>n.addOption("summary","Summary").addOption("fulltext","Full Text").setValue(this.plugin.settings.feedMode).onChange(async i=>{this.plugin.settings.feedMode=i,await this.plugin.saveSettings()})),new B.Setting(e).setName("Clean HTML").setDesc("Remove scripts, styles, and other unnecessary HTML elements").addToggle(n=>n.setValue(this.plugin.settings.enableCleanHtml).onChange(async i=>{this.plugin.settings.enableCleanHtml=i,await this.plugin.saveSettings()}))}addTitleFilteringSettings(e){e.createEl("h3",{text:"Title Filtering"}),e.createEl("p",{text:"Use regex patterns to filter articles by title. Leave empty to include all articles.",cls:"setting-item-description"}),new B.Setting(e).setName("Include Patterns").setDesc("Only sync articles matching these patterns (comma-separated regex)").addTextArea(n=>{n.setPlaceholder("Example: AI, Machine Learning, \u4EBA\u5DE5\u667A\u80FD").setValue(this.plugin.settings.titleIncludePatterns.join(", ")).onChange(async i=>{this.plugin.settings.titleIncludePatterns=i.split(",").map(o=>o.trim()).filter(o=>o.length>0),await this.plugin.saveSettings()}),n.inputEl.rows=3}),new B.Setting(e).setName("Exclude Patterns").setDesc("Skip articles matching these patterns (comma-separated regex)").addTextArea(n=>{n.setPlaceholder("Example: \u5E7F\u544A, \u63A8\u5E7F, Advertisement").setValue(this.plugin.settings.titleExcludePatterns.join(", ")).onChange(async i=>{this.plugin.settings.titleExcludePatterns=i.split(",").map(o=>o.trim()).filter(o=>o.length>0),await this.plugin.saveSettings()}),n.inputEl.rows=3})}addApiSettings(e){e.createEl("h3",{text:"API Settings"}),new B.Setting(e).setName("Platform URL").setDesc("WeChat Reading API base URL (change only if you know what you're doing)").addText(n=>n.setPlaceholder("https://weread.111965.xyz").setValue(this.plugin.settings.platformUrl).onChange(async i=>{this.plugin.settings.platformUrl=i,await this.plugin.saveSettings()})),new B.Setting(e).setName("Max Requests Per Minute").setDesc("Rate limit for API requests (lower value = safer)").addSlider(n=>n.setLimits(10,120,10).setValue(this.plugin.settings.maxRequestsPerMinute).setDynamicTooltip().onChange(async i=>{this.plugin.settings.maxRequestsPerMinute=i,await this.plugin.saveSettings()}))}addAdvancedSettings(e){e.createEl("h3",{text:"Advanced"});let n=e.createEl("div",{cls:"wewe-rss-stats-container"});this.plugin.syncService.getSyncStats().then(i=>{n.createEl("p",{text:"\u{1F4CA} Database Statistics:",cls:"wewe-rss-stats-title"});let o=n.createEl("ul",{cls:"wewe-rss-stats-list"});o.createEl("li",{text:`Total Feeds: ${i.totalFeeds}`}),o.createEl("li",{text:`Total Articles: ${i.totalArticles}`}),o.createEl("li",{text:`Synced Articles: ${i.syncedArticles}`}),o.createEl("li",{text:`Unsynced Articles: ${i.unsyncedArticles}`});let s=this.plugin.databaseService.accounts.findAll();o.createEl("li",{text:`Accounts: ${s.length}`})}),new B.Setting(e).setName("Cleanup Old Articles").setDesc("Delete old articles from database (notes are preserved). You can specify how many days to keep.").addButton(i=>i.setButtonText("Clean Up").setWarning().onClick(async()=>{let o=this.plugin.settings.lastCleanupRetentionDays||30,s=this.plugin.databaseService.articles.countArticlesOlderThan(o),{CleanupArticlesModal:d}=await Promise.resolve().then(()=>(Zr(),Jr));new d(this.app,async h=>{this.plugin.settings.lastCleanupRetentionDays=h,await this.plugin.saveSettings();let p=await this.plugin.syncService.cleanupOldArticles(h);new B.Notice(`Cleaned up ${p.articlesDeleted} articles and ${p.notesDeleted} notes (older than ${h} days)`),this.display()},o,s).open()})),new B.Setting(e).setName("Database Location").setDesc(`${this.plugin.settings.databasePath}`).setClass("wewe-rss-readonly-setting")}addAccountManagement(e){e.createEl("h3",{text:"Account Management"}),e.createEl("p",{text:"Manage WeChat Reading accounts used for feed synchronization.",cls:"setting-item-description"});let n=this.plugin.databaseService.accounts.findAll(),i=n.filter(s=>s.status==="active").length;if(e.createEl("div",{cls:"wewe-rss-account-stats"}).createEl("span",{text:`Total Accounts: ${n.length} | Active: ${i}`,cls:"wewe-rss-stats-text"}),n.length===0){let s=e.createEl("div",{cls:"wewe-rss-no-accounts"});s.createEl("p",{text:"\u{1F4ED} No accounts added yet."}),s.createEl("p",{text:'Click "Add Account" below to get started.'})}else n.forEach(s=>{let d=new B.Setting(e).setName(s.name).setDesc(this.getAccountDescription(s));d.nameEl.createSpan({cls:`wewe-rss-status-badge wewe-rss-status-${s.status}`}).setText(s.status.toUpperCase()),d.addButton(p=>p.setButtonText("Delete").setWarning().onClick(async()=>{await this.confirmAccountDeletion(s.name)&&(this.plugin.databaseService.accounts.delete(s.id),new B.Notice(`Account "${s.name}" deleted`),this.display())}))});new B.Setting(e).setName("Add New Account").setDesc("Scan QR code to authenticate a new WeChat account").addButton(s=>s.setButtonText("Add Account").setCta().onClick(async()=>{let{AddAccountModal:d}=await Promise.resolve().then(()=>(Qt(),ts));new d(this.app,this.plugin).open()}))}getAccountDescription(e){let i=`Created: ${new Date(e.createdAt).toLocaleDateString()}`;if(e.status==="blacklisted"&&e.blacklistedUntil){let o=new Date(e.blacklistedUntil).toLocaleString();i+=` | Blacklisted until: ${o}`}return i}async confirmAccountDeletion(e){return new Promise(n=>{let i=new B.Modal(this.app);i.titleEl.setText("Delete Account?"),i.contentEl.createEl("p",{text:`Are you sure you want to delete "${e}"?`}),i.contentEl.createEl("p",{text:"All feeds using this account will stop syncing.",cls:"mod-warning"});let o=i.contentEl.createEl("div",{cls:"modal-button-container"});o.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{i.close(),n(!1)}),o.createEl("button",{text:"Delete",cls:"mod-warning"}).addEventListener("click",()=>{i.close(),n(!0)}),i.open()})}};var Be=require("obsidian");Qt();var ie=require("obsidian");Y();var je=class extends ie.Modal{plugin;logger;wxsLinkInput;submitBtn;isSubmitting=!1;constructor(e,n){super(e),this.plugin=n,this.logger=new K("AddFeedModal")}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("wewe-rss-add-feed-modal"),e.createEl("h2",{text:"Add WeChat Feed"});let n=e.createEl("div",{cls:"wewe-rss-modal-instructions"});n.createEl("p",{text:"Subscribe to a WeChat public account by pasting the share link below."});let i=n.createEl("ol",{cls:"wewe-rss-steps-list"});i.createEl("li",{text:"Open WeChat app and find the public account you want to follow"}),i.createEl("li",{text:'Tap the "..." menu and select "Share"'}),i.createEl("li",{text:"Copy the share link"}),i.createEl("li",{text:"Paste the link below"}),new ie.Setting(e).setName("WeChat Share Link").setDesc("Example: https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=...").addText(h=>{this.wxsLinkInput=h.inputEl,h.setPlaceholder("https://mp.weixin.qq.com/...").inputEl.addClass("wewe-rss-wide-input"),h.inputEl.addEventListener("keydown",p=>{p.key==="Enter"&&this.handleSubmit()})}),e.createEl("div",{cls:"wewe-rss-example-container"}).createEl("small",{text:'Tip: The link should start with "https://mp.weixin.qq.com/"',cls:"wewe-rss-hint-text"});let s=e.createEl("div",{cls:"wewe-rss-modal-buttons"});s.createEl("button",{text:"Cancel",cls:"wewe-rss-btn"}).addEventListener("click",()=>{this.close()}),this.submitBtn=s.createEl("button",{text:"Subscribe",cls:"wewe-rss-btn wewe-rss-btn-primary"}),this.submitBtn.addEventListener("click",()=>{this.handleSubmit()})}async handleSubmit(){if(this.isSubmitting)return;let e=this.wxsLinkInput.value.trim();if(!e){new ie.Notice("Please enter a WeChat share link");return}if(!e.includes("mp.weixin.qq.com")){new ie.Notice("Invalid WeChat share link. Please check the URL.");return}try{this.isSubmitting=!0,this.submitBtn.disabled=!0,this.submitBtn.textContent="Subscribing...",this.logger.info("Subscribing to feed:",e);let n=await this.plugin.feedService.subscribeFeed(e);if(this.logger.info("Feed subscribed successfully:",n),new ie.Notice(`Subscribed to "${n.title}"!`),await this.confirmFetchArticles(n.title)){this.submitBtn.textContent="Fetching articles...";try{let s=await this.plugin.feedService.fetchHistoricalArticles(n.id,n.feedId);new ie.Notice(`Downloaded ${s} articles from "${n.title}"`)}catch(s){this.logger.error("Failed to fetch articles:",s),new ie.Notice(`Feed subscribed, but failed to fetch articles: ${s.message}`)}}this.close();let o=this.app.workspace.getLeavesOfType("wewe-rss-view");if(o.length>0){let s=o[0].view;s.refresh&&await s.refresh()}}catch(n){this.logger.error("Failed to subscribe to feed:",n),new ie.Notice(`Failed to subscribe: ${n.message}`),this.submitBtn.disabled=!1,this.submitBtn.textContent="Subscribe",this.isSubmitting=!1}}async confirmFetchArticles(e){return new Promise(n=>{let i=new ie.Modal(this.app);i.contentEl.createEl("h3",{text:"Fetch Articles?"}),i.contentEl.createEl("p",{text:`Would you like to download recent articles from "${e}" now?`}),i.contentEl.createEl("p",{text:"This may take a few seconds. You can also sync later.",cls:"wewe-rss-hint-text"});let o=i.contentEl.createEl("div",{cls:"wewe-rss-modal-buttons"});o.createEl("button",{text:"Skip",cls:"wewe-rss-btn"}).addEventListener("click",()=>{i.close(),n(!1)}),o.createEl("button",{text:"Fetch Now",cls:"wewe-rss-btn wewe-rss-btn-primary"}).addEventListener("click",()=>{i.close(),n(!0)}),i.open()})}onClose(){let{contentEl:e}=this;e.empty(),this.isSubmitting=!1}};var gt="wewe-rss-view",jt=class extends Be.ItemView{plugin;feedsContainer;articlesContainer;selectedFeedId=null;constructor(e,n){super(e),this.plugin=n}getViewType(){return gt}getDisplayText(){return"WeWe RSS"}getIcon(){return"rss"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("wewe-rss-sidebar"),this.renderHeader(e),await this.renderStats(e);let n=e.createEl("div",{cls:"wewe-rss-main-content"}),i=n.createEl("div",{cls:"wewe-rss-feeds-section"});i.createEl("h5",{text:"Feeds"}),this.feedsContainer=i.createEl("div",{cls:"wewe-rss-feeds-list"});let o=n.createEl("div",{cls:"wewe-rss-articles-section"});o.createEl("h5",{text:"Articles"}),this.articlesContainer=o.createEl("div",{cls:"wewe-rss-articles-list"}),await this.refresh()}renderHeader(e){let n=e.createEl("div",{cls:"wewe-rss-header"});n.createEl("h4",{text:"WeWe RSS"}).addClass("wewe-rss-title");let o=n.createEl("div",{cls:"wewe-rss-button-group"});o.createEl("button",{text:"+ Account",cls:"wewe-rss-btn wewe-rss-btn-small"}).addEventListener("click",()=>{new Me(this.app,this.plugin).open()}),o.createEl("button",{text:"+ Feed",cls:"wewe-rss-btn wewe-rss-btn-small"}).addEventListener("click",()=>{new je(this.app,this.plugin).open()}),o.createEl("button",{text:"\u27F3 Sync",cls:"wewe-rss-btn wewe-rss-btn-small wewe-rss-btn-primary"}).addEventListener("click",async()=>{await this.handleSync()})}async renderStats(e){let n=await this.plugin.syncService.getSyncStats(),i=e.createEl("div",{cls:"wewe-rss-stats-bar"});if(i.createEl("span",{text:`\u{1F4DA} ${n.totalFeeds} feeds`,cls:"wewe-rss-stat"}),i.createEl("span",{text:`\u{1F4C4} ${n.totalArticles} articles`,cls:"wewe-rss-stat"}),n.unsyncedArticles>0&&i.createEl("span",{text:`\u26A0\uFE0F ${n.unsyncedArticles} unsynced`,cls:"wewe-rss-stat wewe-rss-stat-warning"}),n.lastSyncTime){let o=this.getTimeAgo(n.lastSyncTime);i.createEl("span",{text:`\u{1F552} Last sync: ${o}`,cls:"wewe-rss-stat wewe-rss-stat-muted"})}}async renderFeeds(){this.feedsContainer.empty();let e=this.plugin.databaseService.feeds.findAll();if(e.length===0){this.feedsContainer.createEl("div",{text:'No feeds yet. Click "+ Feed" to add one.',cls:"wewe-rss-empty-state"});return}for(let n of e){let i=this.feedsContainer.createEl("div",{cls:"wewe-rss-feed-item"});this.selectedFeedId===n.id&&i.addClass("wewe-rss-feed-item-selected");let o=i.createEl("div",{text:n.title,cls:"wewe-rss-feed-title"}),s=i.createEl("div",{cls:"wewe-rss-feed-stats"}),d=this.plugin.databaseService.articles.countByFeed(n.id);if(s.createEl("span",{text:`${d} articles`,cls:"wewe-rss-feed-count"}),n.lastSyncAt){let h=this.getTimeAgo(new Date(n.lastSyncAt));s.createEl("span",{text:h,cls:"wewe-rss-feed-sync-time"})}i.addEventListener("click",()=>{this.selectedFeedId=n.id,this.renderFeeds(),this.renderArticles()})}}async renderArticles(){this.articlesContainer.empty();let e;if(this.selectedFeedId?e=this.plugin.databaseService.articles.findByFeedId(this.selectedFeedId,50):e=this.plugin.databaseService.articles.findRecent(20),e.length===0){this.articlesContainer.createEl("div",{text:"No articles yet. Sync feeds to download articles.",cls:"wewe-rss-empty-state"});return}for(let n of e){let i=this.articlesContainer.createEl("div",{cls:"wewe-rss-article-item"});n.synced&&i.addClass("wewe-rss-article-synced");let o=i.createEl("div",{text:n.title,cls:"wewe-rss-article-title"}),s=i.createEl("div",{cls:"wewe-rss-article-meta"}),d=new Date(n.publishedAt);s.createEl("span",{text:d.toLocaleDateString(),cls:"wewe-rss-article-date"}),n.synced&&n.noteId&&s.createEl("span",{text:"\u{1F4DD} Note",cls:"wewe-rss-article-note-link"}).addEventListener("click",async p=>{p.stopPropagation();let y=this.plugin.noteCreator.getNote(n.noteId);y?await this.app.workspace.getLeaf().openFile(y):new Be.Notice("Note not found")}),i.addEventListener("click",async()=>{if(n.synced){if(n.noteId){let h=this.plugin.noteCreator.getNote(n.noteId);h&&await this.app.workspace.getLeaf().openFile(h)}}else{let h=this.plugin.databaseService.feeds.findById(n.feedId);if(h){let p=await this.plugin.noteCreator.createNoteFromArticle(n,h);p&&(new Be.Notice("Note created!"),await this.app.workspace.getLeaf().openFile(p),await this.refresh())}}})}}async handleSync(){let e=this.containerEl.querySelector(".wewe-rss-btn-primary");if(e)try{e.disabled=!0,e.textContent="\u27F3 Syncing...";let n=await this.plugin.syncService.syncAll();new Be.Notice(`Sync complete! ${n.feedsRefreshed} feeds, ${n.articlesDownloaded} articles, ${n.notesCreated} notes created`),await this.refresh()}catch(n){new Be.Notice(`Sync failed: ${n.message}`)}finally{e.disabled=!1,e.textContent="\u27F3 Sync"}}async refresh(){await this.renderFeeds(),await this.renderArticles();let e=this.containerEl.querySelector(".wewe-rss-stats-bar");e&&(e.empty(),await this.renderStats(this.containerEl.children[1]))}getTimeAgo(e){let n=Math.floor((Date.now()-e.getTime())/1e3);return n<60?"just now":n<3600?`${Math.floor(n/60)}m ago`:n<86400?`${Math.floor(n/3600)}h ago`:n<604800?`${Math.floor(n/86400)}d ago`:e.toLocaleDateString()}async onClose(){}};Qt();var as=require("obsidian");var is=Kr(rs());Y();var ir=class{SQL=null;initialized=!1;async initialize(){if(this.initialized){m.debug("sql.js already initialized");return}try{m.info("Initializing sql.js..."),this.SQL=await(0,is.default)({locateFile:e=>`https://sql.js.org/dist/${e}`}),this.initialized=!0,m.info("sql.js initialized successfully")}catch(e){throw m.error("Failed to initialize sql.js:",e),new Error("Failed to initialize database engine")}}createDatabase(){if(!this.SQL)throw new Error("sql.js not initialized. Call initialize() first.");return m.debug("Creating new in-memory database"),new this.SQL.Database}loadDatabase(e){if(!this.SQL)throw new Error("sql.js not initialized. Call initialize() first.");return m.debug("Loading database from buffer"),new this.SQL.Database(e)}exportDatabase(e){return m.debug("Exporting database to buffer"),e.export()}isInitialized(){return this.initialized}},mt=new ir;Y();var ss="wewe-rss.db";Y();var bt=class{db;constructor(e){this.db=e}async create(e,n){let i=Date.now();this.db.execute(`INSERT INTO accounts (name, cookie, status, created_at, updated_at)
			VALUES (?, ?, ?, ?, ?)`,[e,n,"active",i,i]);let o=this.db.getLastInsertId();return m.info("Account created:",{id:o,name:e}),{id:o,name:e,cookie:n,status:"active",createdAt:i,updatedAt:i}}findById(e){let n=this.db.queryOne("SELECT * FROM accounts WHERE id = ?",[e]);return n?this.mapToAccount(n):null}findAll(){return this.db.query("SELECT * FROM accounts ORDER BY created_at DESC").map(n=>this.mapToAccount(n))}findActive(){return this.db.query(`SELECT * FROM accounts
			WHERE status = ? OR status = ?
			ORDER BY created_at DESC`,["active","blacklisted"]).map(n=>this.mapToAccount(n))}findByStatus(e){return this.db.query("SELECT * FROM accounts WHERE status = ? ORDER BY created_at DESC",[e]).map(i=>this.mapToAccount(i))}updateStatus(e,n,i){let o=Date.now();i!==void 0?this.db.execute(`UPDATE accounts
				SET status = ?, blacklisted_until = ?, updated_at = ?
				WHERE id = ?`,[n,i,o,e]):this.db.execute(`UPDATE accounts
				SET status = ?, blacklisted_until = NULL, updated_at = ?
				WHERE id = ?`,[n,o,e]),m.info("Account status updated:",{id:e,status:n,blacklistedUntil:i})}blacklist(e,n=24*60*60*1e3){let i=Date.now()+n;this.updateStatus(e,"blacklisted",i),m.warn("Account blacklisted until:",new Date(i).toISOString())}checkAndClearBlacklist(e){let n=this.findById(e);return n&&n.status==="blacklisted"&&n.blacklistedUntil&&Date.now()>n.blacklistedUntil?(this.updateStatus(e,"active"),m.info("Account blacklist cleared:",e),!0):!1}updateCookie(e,n){let i=Date.now();this.db.execute("UPDATE accounts SET cookie = ?, updated_at = ? WHERE id = ?",[n,i,e]),m.info("Account cookie updated:",e)}updateName(e,n){let i=Date.now();this.db.execute("UPDATE accounts SET name = ?, updated_at = ? WHERE id = ?",[n,i,e]),m.info("Account name updated:",{id:e,name:n})}delete(e){this.db.execute("DELETE FROM accounts WHERE id = ?",[e]),m.info("Account deleted:",e)}count(){return this.db.queryOne("SELECT COUNT(*) as count FROM accounts")?.count||0}countByStatus(e){return this.db.queryOne("SELECT COUNT(*) as count FROM accounts WHERE status = ?",[e])?.count||0}mapToAccount(e){return{id:e.id,name:e.name,cookie:e.cookie,status:e.status,blacklistedUntil:e.blacklisted_until||void 0,createdAt:e.created_at,updatedAt:e.updated_at}}};Y();var wt=class{db;constructor(e){this.db=e}async create(e,n,i,o){let s=Date.now(),d=this.findByFeedId(e);if(d)return m.warn("Feed already exists:",e),d;this.db.execute(`INSERT INTO feeds (feed_id, title, description, account_id, created_at, updated_at)
			VALUES (?, ?, ?, ?, ?, ?)`,[e,n,i,o,s,s]);let h=this.db.getLastInsertId();return m.info("Feed created:",{id:h,feedId:e,title:n}),{id:h,feedId:e,title:n,description:i,accountId:o,createdAt:s,updatedAt:s}}findById(e){let n=this.db.queryOne("SELECT * FROM feeds WHERE id = ?",[e]);return n?this.mapToFeed(n):null}findByFeedId(e){let n=this.db.queryOne("SELECT * FROM feeds WHERE feed_id = ?",[e]);return n?this.mapToFeed(n):null}findAll(){return this.db.query("SELECT * FROM feeds ORDER BY created_at DESC").map(n=>this.mapToFeed(n))}findByAccountId(e){return this.db.query("SELECT * FROM feeds WHERE account_id = ? ORDER BY created_at DESC",[e]).map(i=>this.mapToFeed(i))}findNeedingSync(e=60*60*1e3){let n=Date.now()-e;return this.db.query(`SELECT * FROM feeds
			WHERE last_sync_at IS NULL OR last_sync_at < ?
			ORDER BY last_sync_at ASC NULLS FIRST`,[n]).map(o=>this.mapToFeed(o))}updateMetadata(e,n,i){let o=Date.now();this.db.execute("UPDATE feeds SET title = ?, description = ?, updated_at = ? WHERE id = ?",[n,i,o,e]),m.info("Feed metadata updated:",{id:e,title:n})}updateLastSync(e,n){let i=n||Date.now(),o=Date.now();this.db.execute("UPDATE feeds SET last_sync_at = ?, updated_at = ? WHERE id = ?",[i,o,e]),m.debug("Feed sync timestamp updated:",{id:e,syncTime:i})}updateAccount(e,n){let i=Date.now();this.db.execute("UPDATE feeds SET account_id = ?, updated_at = ? WHERE id = ?",[n,i,e]),m.info("Feed account updated:",{id:e,accountId:n})}delete(e){this.db.execute("DELETE FROM feeds WHERE id = ?",[e]),m.info("Feed deleted:",e)}deleteByFeedId(e){this.db.execute("DELETE FROM feeds WHERE feed_id = ?",[e]),m.info("Feed deleted by feedId:",e)}count(){return this.db.queryOne("SELECT COUNT(*) as count FROM feeds")?.count||0}countByAccount(e){return this.db.queryOne("SELECT COUNT(*) as count FROM feeds WHERE account_id = ?",[e])?.count||0}getFeedStats(){return this.db.query(`SELECT f.*, COUNT(a.id) as article_count
			FROM feeds f
			LEFT JOIN articles a ON a.feed_id = f.id
			GROUP BY f.id
			ORDER BY f.created_at DESC`).map(n=>({...this.mapToFeed(n),articleCount:n.article_count||0}))}mapToFeed(e){return{id:e.id,feedId:e.feed_id,title:e.title,description:e.description||"",accountId:e.account_id,lastSyncAt:e.last_sync_at||void 0,createdAt:e.created_at,updatedAt:e.updated_at}}};Y();var yt=class{db;constructor(e){this.db=e}async create(e,n,i,o,s,d){let h=Date.now(),p=this.findByUrl(s);if(p)return m.debug("Article already exists:",s),p;this.db.execute(`INSERT INTO articles (feed_id, title, content, content_html, url, published_at, created_at)
			VALUES (?, ?, ?, ?, ?, ?, ?)`,[e,n,i,o,s,d,h]);let y=this.db.getLastInsertId();return m.info("Article created:",{id:y,title:n}),{id:y,feedId:e,title:n,content:i,contentHtml:o,url:s,publishedAt:d,synced:!1,createdAt:h}}async createBatch(e){if(e.length===0)return 0;let n=Date.now(),i=0;this.db.beginTransaction();try{for(let o of e)this.findByUrl(o.url)||(this.db.execute(`INSERT INTO articles (feed_id, title, content, content_html, url, published_at, created_at)
					VALUES (?, ?, ?, ?, ?, ?, ?)`,[o.feedId,o.title,o.content,o.contentHtml,o.url,o.publishedAt,n]),i++);this.db.commit(),m.info("Batch articles created:",i)}catch(o){throw this.db.rollback(),m.error("Failed to create batch articles:",o),o}return i}findAll(){return this.db.query("SELECT * FROM articles ORDER BY published_at DESC").map(n=>this.mapToArticle(n))}findById(e){let n=this.db.queryOne("SELECT * FROM articles WHERE id = ?",[e]);return n?this.mapToArticle(n):null}findByUrl(e){let n=this.db.queryOne("SELECT * FROM articles WHERE url = ?",[e]);return n?this.mapToArticle(n):null}findByFeedId(e,n){let i=n?"SELECT * FROM articles WHERE feed_id = ? ORDER BY published_at DESC LIMIT ?":"SELECT * FROM articles WHERE feed_id = ? ORDER BY published_at DESC",o=n?[e,n]:[e];return this.db.query(i,o).map(d=>this.mapToArticle(d))}findUnsynced(e){let n=e?"SELECT * FROM articles WHERE synced = 0 ORDER BY published_at DESC LIMIT ?":"SELECT * FROM articles WHERE synced = 0 ORDER BY published_at DESC",i=e?[e]:[];return this.db.query(n,i).map(s=>this.mapToArticle(s))}findUnsyncedByFeed(e,n){let i=n?"SELECT * FROM articles WHERE feed_id = ? AND synced = 0 ORDER BY published_at DESC LIMIT ?":"SELECT * FROM articles WHERE feed_id = ? AND synced = 0 ORDER BY published_at DESC",o=n?[e,n]:[e];return this.db.query(i,o).map(d=>this.mapToArticle(d))}findRecent(e=50){return this.db.query("SELECT * FROM articles ORDER BY published_at DESC LIMIT ?",[e]).map(i=>this.mapToArticle(i))}searchByTitle(e,n=50){return this.db.query("SELECT * FROM articles WHERE title LIKE ? ORDER BY published_at DESC LIMIT ?",[`%${e}%`,n]).map(o=>this.mapToArticle(o))}markAsSynced(e,n){this.db.execute("UPDATE articles SET synced = 1, note_id = ? WHERE id = ?",[n,e]),m.debug("Article marked as synced:",{id:e,noteId:n})}markBatchAsSynced(e){if(e.length!==0){this.db.beginTransaction();try{for(let n of e)this.db.execute("UPDATE articles SET synced = 1 WHERE id = ?",[n]);this.db.commit(),m.info("Batch articles marked as synced:",e.length)}catch(n){throw this.db.rollback(),m.error("Failed to mark batch as synced:",n),n}}}update(e,n){let i=[],o=[];n.title!==void 0&&(i.push("title = ?"),o.push(n.title)),n.content!==void 0&&(i.push("content = ?"),o.push(n.content)),n.contentHtml!==void 0&&(i.push("content_html = ?"),o.push(n.contentHtml)),n.noteId!==void 0&&(i.push("note_id = ?"),o.push(n.noteId)),n.synced!==void 0&&(i.push("synced = ?"),o.push(n.synced?1:0)),i.length!==0&&(o.push(e),this.db.execute(`UPDATE articles SET ${i.join(", ")} WHERE id = ?`,o),m.info("Article updated:",e))}updateContent(e,n,i){this.db.execute("UPDATE articles SET content = ?, content_html = ? WHERE id = ?",[n,i,e]),m.info("Article content updated:",e)}delete(e){this.db.execute("DELETE FROM articles WHERE id = ?",[e]),m.info("Article deleted:",e)}deleteByFeedId(e){this.db.execute("DELETE FROM articles WHERE feed_id = ?",[e]),m.info("Articles deleted for feed:",e)}deleteOlderThan(e){let i=this.db.query("SELECT COUNT(*) as count FROM articles WHERE published_at < ?",[e])[0]?.count||0;return i>0&&(this.db.execute("DELETE FROM articles WHERE published_at < ?",[e]),m.info("Old articles deleted:",i)),i}cleanupOldArticles(e){let n=Date.now()-e*24*60*60*1e3,o=this.db.query("SELECT id FROM articles WHERE published_at < ?",[n]).map(s=>s.id);return o.length>0&&(this.db.execute("DELETE FROM articles WHERE published_at < ?",[n]),m.info(`Old articles deleted: ${o.length} (older than ${e} days)`)),{deletedIds:o,count:o.length}}cleanupSynced(e=30){let n=Date.now()-e*24*60*60*1e3,o=this.db.query("SELECT COUNT(*) as count FROM articles WHERE synced = 1 AND published_at < ?",[n])[0]?.count||0;return o>0&&(this.db.execute("DELETE FROM articles WHERE synced = 1 AND published_at < ?",[n]),m.info("Synced articles cleaned up:",o)),o}count(){return this.db.queryOne("SELECT COUNT(*) as count FROM articles")?.count||0}countByFeed(e){return this.db.queryOne("SELECT COUNT(*) as count FROM articles WHERE feed_id = ?",[e])?.count||0}countUnsynced(){return this.db.queryOne("SELECT COUNT(*) as count FROM articles WHERE synced = 0")?.count||0}countArticlesOlderThan(e){let n=Date.now()-e*24*60*60*1e3;return this.db.queryOne("SELECT COUNT(*) as count FROM articles WHERE published_at < ?",[n])?.count||0}getStats(){let e=this.count(),n=this.count()-this.countUnsynced(),i=this.countUnsynced(),s=this.db.query("SELECT feed_id, COUNT(*) as count FROM articles GROUP BY feed_id").map(d=>({feedId:d.feed_id,count:d.count}));return{total:e,synced:n,unsynced:i,byFeed:s}}mapToArticle(e){return{id:e.id,feedId:e.feed_id,title:e.title,content:e.content,contentHtml:e.content_html,url:e.url,publishedAt:e.published_at,synced:e.synced===1,noteId:e.note_id||void 0,createdAt:e.created_at}}};var Zt=class{plugin;db=null;initialized=!1;dbPath;saveTimer=null;accounts;feeds;articles;constructor(e){this.plugin=e,this.dbPath=(0,as.normalizePath)(`${e.manifest.dir}/${ss}`),this.accounts=new bt(this),this.feeds=new wt(this),this.articles=new yt(this)}async initialize(){if(this.initialized){m.debug("Database already initialized");return}try{if(m.info("Initializing database..."),await mt.initialize(),await this.plugin.app.vault.adapter.exists(this.dbPath)){m.info("Loading existing database from:",this.dbPath);let n=await this.plugin.app.vault.adapter.readBinary(this.dbPath);this.db=mt.loadDatabase(new Uint8Array(n)),m.info("Database loaded successfully")}else m.info("Creating new database"),this.db=mt.createDatabase(),await this.runMigrations(),await this.save(),m.info("New database created and saved");this.initialized=!0,this.setupAutoSave()}catch(e){throw m.error("Failed to initialize database:",e),e}}async runMigrations(){if(!this.db)throw new Error("Database not initialized");m.info("Running database migrations..."),this.db.run(`
			CREATE TABLE IF NOT EXISTS migrations (
				id INTEGER PRIMARY KEY AUTOINCREMENT,
				name TEXT NOT NULL UNIQUE,
				applied_at INTEGER NOT NULL
			)
		`);let e=this.db.exec(`
			SELECT name FROM migrations WHERE name = '001_initial'
		`);e.length===0||e[0].values.length===0?(m.info("Running migration: 001_initial"),await this.runInitialMigration(),this.db.run(`
				INSERT INTO migrations (name, applied_at)
				VALUES ('001_initial', ?)
			`,[Date.now()]),m.info("Migration 001_initial completed")):m.info("Database already migrated")}async runInitialMigration(){if(!this.db)throw new Error("Database not initialized");this.db.run(`
			CREATE TABLE IF NOT EXISTS accounts (
				id INTEGER PRIMARY KEY AUTOINCREMENT,
				name TEXT NOT NULL,
				cookie TEXT NOT NULL,
				status TEXT NOT NULL DEFAULT 'active',
				blacklisted_until INTEGER,
				created_at INTEGER NOT NULL,
				updated_at INTEGER NOT NULL
			)
		`),this.db.run(`
			CREATE TABLE IF NOT EXISTS feeds (
				id INTEGER PRIMARY KEY AUTOINCREMENT,
				feed_id TEXT NOT NULL UNIQUE,
				title TEXT NOT NULL,
				description TEXT,
				account_id INTEGER NOT NULL,
				last_sync_at INTEGER,
				created_at INTEGER NOT NULL,
				updated_at INTEGER NOT NULL,
				FOREIGN KEY (account_id) REFERENCES accounts(id) ON DELETE CASCADE
			)
		`),this.db.run(`
			CREATE TABLE IF NOT EXISTS articles (
				id INTEGER PRIMARY KEY AUTOINCREMENT,
				feed_id INTEGER NOT NULL,
				title TEXT NOT NULL,
				content TEXT NOT NULL,
				content_html TEXT NOT NULL,
				url TEXT NOT NULL UNIQUE,
				published_at INTEGER NOT NULL,
				synced INTEGER NOT NULL DEFAULT 0,
				note_id TEXT,
				created_at INTEGER NOT NULL,
				FOREIGN KEY (feed_id) REFERENCES feeds(id) ON DELETE CASCADE
			)
		`),this.db.run(`
			CREATE TABLE IF NOT EXISTS settings (
				key TEXT PRIMARY KEY,
				value TEXT NOT NULL
			)
		`),this.db.run("CREATE INDEX IF NOT EXISTS idx_feeds_feed_id ON feeds(feed_id)"),this.db.run("CREATE INDEX IF NOT EXISTS idx_articles_feed_id ON articles(feed_id)"),this.db.run("CREATE INDEX IF NOT EXISTS idx_articles_url ON articles(url)"),this.db.run("CREATE INDEX IF NOT EXISTS idx_articles_synced ON articles(synced)"),m.info("Initial database schema created")}async save(){if(!this.db){m.warn("Cannot save: database not initialized");return}try{m.debug("Saving database to:",this.dbPath);let e=mt.exportDatabase(this.db),n=this.dbPath.substring(0,this.dbPath.lastIndexOf("/"));await this.plugin.app.vault.adapter.exists(n)||await this.plugin.app.vault.adapter.mkdir(n);let i=e.buffer.slice(0);await this.plugin.app.vault.adapter.writeBinary(this.dbPath,i),m.debug("Database saved successfully")}catch(e){throw m.error("Failed to save database:",e),e}}setupAutoSave(){this.saveTimer&&clearInterval(this.saveTimer),this.saveTimer=setInterval(async()=>{await this.save()},3e4),m.info("Auto-save enabled (30s interval)")}async close(){this.saveTimer&&(clearInterval(this.saveTimer),this.saveTimer=null),this.db&&(await this.save(),this.db.close(),this.db=null,m.info("Database connection closed")),this.initialized=!1}query(e,n=[]){if(!this.initialized||!this.db)throw new Error("Database not initialized");try{let i=this.db.exec(e,n);if(i.length===0)return[];let o=i[0].columns;return i[0].values.map(d=>{let h={};return o.forEach((p,y)=>{h[p]=d[y]}),h})}catch(i){throw m.error("Query failed:",e,i),i}}queryOne(e,n=[]){let i=this.query(e,n);return i.length>0?i[0]:null}execute(e,n=[]){if(!this.initialized||!this.db)throw new Error("Database not initialized");try{this.db.run(e,n)}catch(i){throw m.error("Execute failed:",e,i),i}}getLastInsertId(){if(!this.db)throw new Error("Database not initialized");return this.db.exec("SELECT last_insert_rowid() as id")[0].values[0][0]}beginTransaction(){this.execute("BEGIN TRANSACTION")}commit(){this.execute("COMMIT")}rollback(){this.execute("ROLLBACK")}};var os=require("obsidian");Y();var Ke=class{baseUrl;timeout=15e3;constructor(e){this.baseUrl=e}async createLoginUrl(){try{m.info("Creating login URL...");let e=await this.request({url:`${this.baseUrl}/api/v2/login/platform`,method:"GET"});return m.info("Login URL created:",e.uuid),e}catch(e){throw m.error("Failed to create login URL:",e),this.handleError(e)}}async getLoginResult(e){try{m.debug("Checking login result for UUID:",e);let n=await this.request({url:`${this.baseUrl}/api/v2/login/platform/${e}`,method:"GET"},12e4,void 0,{maxRetries:2,backoffMs:2e3});return n.token&&n.vid?m.info("Login successful:",n.username):m.debug("Login pending:",n.message),n}catch(n){throw m.error("Failed to get login result:",n),this.handleError(n)}}async getMpInfo(e){try{m.info("Getting MP info from link:",e);let n=await this.request({url:`${this.baseUrl}/api/v2/platform/wxs2mp`,method:"POST",body:JSON.stringify({url:e.trim()}),headers:{"Content-Type":"application/json"}});return m.info("MP info retrieved:",n.length>0?n[0].name:"none"),n}catch(n){throw m.error("Failed to get MP info:",n),this.handleError(n)}}async getMpInfoWithAuth(e,n,i){try{return m.info("Getting MP info with auth:",e),await this.request({url:`${this.baseUrl}/api/v2/platform/wxs2mp`,method:"POST",body:JSON.stringify({url:e.trim()}),headers:{"Content-Type":"application/json",xid:n,Authorization:`Bearer ${i}`}})}catch(o){throw m.error("Failed to get MP info with auth:",o),this.handleError(o,n)}}async fetchArticleContent(e){try{m.debug("Fetching article content:",e);let n=await this.request({url:e,method:"GET"},void 0,void 0,{rawResponse:!0});return m.debug("Article content fetched successfully"),n}catch(n){throw m.error("Failed to fetch article content:",n),this.handleError(n)}}async getMpArticles(e,n,i,o=1){try{m.debug(`Getting articles for MP: ${e}, page: ${o}`);let s=await this.request({url:`${this.baseUrl}/api/v2/platform/mps/${e}/articles`,method:"GET",headers:{xid:n,Authorization:`Bearer ${i}`},contentType:"application/json"},void 0,{page:o.toString()});return m.info(`Retrieved ${s.length} articles for ${e}, page ${o}`),s}catch(s){throw m.error(`Failed to get articles for ${e}:`,s),this.handleError(s,n)}}async request(e,n,i,o){if(i){let p=new URLSearchParams(i);e.url=`${e.url}?${p.toString()}`}e.headers||(e.headers={});let s=o?.maxRetries??0,d=o?.backoffMs??1e3,h=o?.rawResponse??!1;for(let p=0;p<=s;p++)try{m.debug("API Request:",{url:e.url,method:e.method,attempt:p+1,maxRetries:s+1});let y=await(0,os.requestUrl)(e);if(y.status>=200&&y.status<300)return m.debug("API Request Success:",{url:e.url,status:y.status}),h?y.text:y.json;throw new Error(`HTTP ${y.status}: ${y.text}`)}catch(y){let S=p===s,D=this.isRetryableError(y);if(m.error("API Request Failed:",{url:e.url,method:e.method,attempt:p+1,maxRetries:s+1,error:y.message,isRetryable:D,isLastAttempt:S}),!S&&D){let _=d*Math.pow(2,p);m.info(`Retrying in ${_}ms...`),await this.sleep(_);continue}throw y}throw new Error("Request failed: max retries exceeded")}isRetryableError(e){let i=(e.message||e.toString()).match(/HTTP (\d+)/);if(i){let o=parseInt(i[1],10);return o>=500&&o<=504}return!1}sleep(e){return new Promise(n=>setTimeout(n,e))}handleError(e,n){let i=e.message||e.toString(),o=i.match(/HTTP (\d+)/),s=o?o[1]:null;return s==="500"?{code:"WeReadError500",message:`Server error (HTTP 500). The WeChat Reading platform (${this.baseUrl}) is experiencing issues. Please try again later or check if the server is operational.`,details:e}:s==="502"?{code:"WeReadError502",message:"Bad gateway error (HTTP 502). The WeChat Reading platform may be temporarily unavailable. Please try again in a few minutes.",details:e}:s==="503"?{code:"WeReadError503",message:"Service unavailable (HTTP 503). The WeChat Reading platform is temporarily down for maintenance. Please try again later.",details:e}:i.includes("WeReadError401")?{code:"WeReadError401",message:`Account (${n}) authentication expired`,details:e}:i.includes("WeReadError429")?{code:"WeReadError429",message:`Account (${n}) rate limited (\u5C0F\u9ED1\u5C4B)`,details:e}:i.includes("WeReadError400")?{code:"WeReadError400",message:"Invalid request parameters",details:e}:{code:"WeReadError500",message:i,details:e}}setPlatformUrl(e){this.baseUrl=e,m.info("Platform URL updated:",e)}getPlatformUrl(){return this.baseUrl}};Y();var en=class{plugin;apiClient;constructor(e){this.plugin=e,this.apiClient=new Ke(e.settings.platformUrl)}async createAccount(){try{m.info("Starting account creation...");let e=await this.apiClient.createLoginUrl();return m.info("Login QR code generated:",e.scanUrl),{uuid:e.uuid,scanUrl:e.scanUrl}}catch(e){throw m.error("Failed to create account:",e),e}}async checkLoginStatus(e){try{let n=await this.apiClient.getLoginResult(e);if(n.token&&n.vid&&n.username){let i=JSON.stringify({vid:n.vid,token:n.token}),o=await this.plugin.databaseService.accounts.create(n.username,i);return m.info("Account created successfully:",o.name),o}return null}catch(n){throw m.error("Failed to check login status:",n),n}}async getAvailableAccount(){let e=this.plugin.databaseService.accounts.findActive();if(e.length===0)return m.warn("No active accounts available"),null;for(let o of e)o.status==="blacklisted"&&this.plugin.databaseService.accounts.checkAndClearBlacklist(o.id);let n=this.plugin.databaseService.accounts.findByStatus("active");if(n.length===0)return m.warn("No active accounts (all blacklisted or disabled)"),null;let i=n[0];return m.debug("Selected account:",i.id),i}async handleApiError(e,n){let i=n;if(!i.code){m.debug("Non-API error, skipping account status update");return}switch(i.code){case"WeReadError401":m.warn(`Account ${e} expired, marking as invalid`),this.plugin.databaseService.accounts.updateStatus(e,"expired");break;case"WeReadError429":m.warn(`Account ${e} rate limited, blacklisting`),this.plugin.databaseService.accounts.blacklist(e,864e5);break;case"WeReadError400":m.error(`Bad request with account ${e}:`,i.message);break;default:m.error(`Unhandled API error for account ${e}:`,i)}}async fetchArticleContent(e){return await this.apiClient.fetchArticleContent(e)}async updateAccountToken(e,n){this.plugin.databaseService.accounts.updateCookie(e,n),m.info("Account token updated:",e)}async updateAccountName(e,n){this.plugin.databaseService.accounts.updateName(e,n),m.info("Account name updated:",e)}async setAccountStatus(e,n){this.plugin.databaseService.accounts.updateStatus(e,n),m.info(`Account ${e} status updated to:`,n)}async deleteAccount(e){this.plugin.databaseService.accounts.delete(e),m.info("Account deleted:",e)}getAllAccounts(){return this.plugin.databaseService.accounts.findAll()}getAccount(e){return this.plugin.databaseService.accounts.findById(e)}getAccountStats(){return{total:this.plugin.databaseService.accounts.count(),active:this.plugin.databaseService.accounts.countByStatus("active"),disabled:this.plugin.databaseService.accounts.countByStatus("disabled"),expired:this.plugin.databaseService.accounts.countByStatus("expired"),blacklisted:this.plugin.databaseService.accounts.countByStatus("blacklisted")}}setPlatformUrl(e){this.apiClient.setPlatformUrl(e),m.info("Platform URL updated in AccountService")}};Y();function ls(c){let e=new Date(c),n=e.toLocaleString("en-US",{month:"long"}),i=e.getDate();return`${n} ${i}`}function sr(c){return c.replace(/[\\/:*?"<>|]/g,"-").replace(/\s+/g," ").trim()}function ar(c,e=30){let n=e*24*60*60*1e3;return Date.now()-c<=n}var tn=class{plugin;apiClient;constructor(e){this.plugin=e,this.apiClient=new Ke(e.settings.platformUrl)}parseCredentials(e){try{let n=JSON.parse(e);if(n.vid&&n.token)return n}catch{}throw new Error("Account credentials are in old format or invalid. Please remove this account and add it again by scanning the QR code in Settings > WeWe RSS > Accounts.")}async subscribeFeed(e){try{m.info("Subscribing to feed:",e);let n=await this.plugin.accountService.getAvailableAccount();if(!n)throw new Error("Please add a WeChat account before subscribing to feeds. Go to Settings > WeWe RSS > Add Account.");let i=this.parseCredentials(n.cookie),o=await this.apiClient.getMpInfoWithAuth(e,n.id.toString(),i.token);if(!o||o.length===0)throw new Error("Failed to get MP info from share link");let s=o[0],d=this.plugin.databaseService.feeds.findByFeedId(s.id);if(d)return m.info("Feed already exists:",s.name),d;let h=await this.plugin.databaseService.feeds.create(s.id,s.name,s.intro||"",n.id);return m.info("Feed subscribed successfully:",h.title),this.fetchHistoricalArticles(h.id,s.id).catch(p=>{m.error("Failed to fetch historical articles:",p)}),h}catch(n){throw m.error("Failed to subscribe to feed:",n),n}}async fetchHistoricalArticles(e,n,i=5){try{m.info(`Fetching historical articles for ${n}...`);let o=this.plugin.databaseService.feeds.findById(e);if(!o)throw new Error("Feed not found");let s=this.plugin.databaseService.accounts.findById(o.accountId);if(!s)throw new Error("Feed account not found");let d=this.parseCredentials(s.cookie),h=0,p=1;for(;p<=i;)try{let y=await this.apiClient.getMpArticles(n,s.id.toString(),d.token,p);if(y.length===0){m.info(`No more articles on page ${p}`);break}let S=this.plugin.settings.articleRetentionDays||30,D=y.filter(Q=>ar(Q.publishTime*1e3,S)),_=y.length-D.length;if(_>0&&m.info(`Filtered ${_} articles older than ${S} days on page ${p}`),D.length===0){m.info(`No recent articles on page ${p}, stopping fetch`);break}let H=D.map(Q=>({feedId:e,title:Q.title,content:"",contentHtml:"",url:`https://mp.weixin.qq.com/s/${Q.id}`,publishedAt:Q.publishTime*1e3})),G=await this.plugin.databaseService.articles.createBatch(H);h+=G,m.info(`Fetched ${G} articles from page ${p}`),p<i&&await this.delay(this.plugin.settings.updateDelay*1e3),p++}catch(y){m.error(`Failed to fetch articles on page ${p}:`,y),await this.plugin.accountService.handleApiError(s.id,y);break}return this.plugin.databaseService.feeds.updateLastSync(e),m.info(`Fetched ${h} historical articles for ${n}`),h}catch(o){throw m.error("Failed to fetch historical articles:",o),o}}async refreshFeed(e){try{let n=this.plugin.databaseService.feeds.findById(e);if(!n)throw new Error("Feed not found");m.info("Refreshing feed:",n.title);let i=this.plugin.databaseService.accounts.findById(n.accountId);if(!i)throw new Error("Feed account not found");let o=this.parseCredentials(i.cookie),s=await this.apiClient.getMpArticles(n.feedId,i.id.toString(),o.token,1);if(s.length===0)return m.info("No new articles found"),this.plugin.databaseService.feeds.updateLastSync(e),0;let d=this.plugin.settings.articleRetentionDays||30,h=s.filter(D=>ar(D.publishTime*1e3,d)),p=s.length-h.length;if(p>0&&m.info(`Filtered ${p} articles older than ${d} days`),h.length===0)return m.info("No recent articles found"),this.plugin.databaseService.feeds.updateLastSync(e),0;let y=h.map(D=>({feedId:e,title:D.title,content:"",contentHtml:"",url:`https://mp.weixin.qq.com/s/${D.id}`,publishedAt:D.publishTime*1e3})),S=await this.plugin.databaseService.articles.createBatch(y);return this.plugin.databaseService.feeds.updateLastSync(e),m.info(`Refreshed ${S} new articles for ${n.title}`),S}catch(n){m.error("Failed to refresh feed:",n);let i=this.plugin.databaseService.feeds.findById(e);throw i&&await this.plugin.accountService.handleApiError(i.accountId,n),n}}async refreshAllFeeds(){let e=this.plugin.databaseService.feeds.findAll(),n={total:e.length,successful:0,failed:0};m.info(`Refreshing ${e.length} feeds...`);for(let i of e)try{await this.refreshFeed(i.id),n.successful++,n.successful<e.length&&await this.delay(this.plugin.settings.updateDelay*1e3)}catch(o){m.error(`Failed to refresh feed ${i.title}:`,o),n.failed++}return m.info(`Refresh complete: ${n.successful}/${n.total} successful`),n}async refreshStaleFeeds(e=1){let n=e*60*60*1e3,i=this.plugin.databaseService.feeds.findNeedingSync(n);m.info(`Found ${i.length} stale feeds to refresh`);let o=0;for(let s of i)try{await this.refreshFeed(s.id),o++,o<i.length&&await this.delay(this.plugin.settings.updateDelay*1e3)}catch(d){m.error(`Failed to refresh stale feed ${s.title}:`,d)}return m.info(`Refreshed ${o} stale feeds`),o}async updateFeedMetadata(e,n,i){this.plugin.databaseService.feeds.updateMetadata(e,n,i),m.info("Feed metadata updated:",e)}async deleteFeed(e){this.plugin.databaseService.articles.deleteByFeedId(e),this.plugin.databaseService.feeds.delete(e),m.info("Feed deleted:",e)}getAllFeeds(){return this.plugin.databaseService.feeds.findAll()}getFeed(e){return this.plugin.databaseService.feeds.findById(e)}getFeedStats(){return this.plugin.databaseService.feeds.getFeedStats()}setPlatformUrl(e){this.apiClient.setPlatformUrl(e),m.info("Platform URL updated in FeedService")}delay(e){return new Promise(n=>setTimeout(n,e))}};var ge=require("obsidian");Y();function Xe(c){return new DOMParser().parseFromString(c,"text/html")}Y();var nn=class{enableCleanHtml;constructor(e=!1){this.enableCleanHtml=e}parseContent(e){try{let n=this.enableCleanHtml?this.cleanHtml(e):e;return{markdown:this.htmlToMarkdown(n),cleanHtml:n}}catch(n){return m.error("Failed to parse content:",n),{markdown:e,cleanHtml:e}}}cleanHtml(e){try{let n=Xe(e);n.querySelectorAll("script").forEach(o=>o.remove()),n.querySelectorAll("style").forEach(o=>o.remove());let i=o=>{for(let s=o.childNodes.length-1;s>=0;s--){let d=o.childNodes[s];d.nodeType===Node.COMMENT_NODE?o.removeChild(d):d.nodeType===Node.ELEMENT_NODE&&i(d)}};return i(n.body),n.querySelectorAll("p").forEach(o=>{o.textContent?.trim()||o.remove()}),n.querySelectorAll("[style]").forEach(o=>{o.removeAttribute("style")}),n.body.innerHTML}catch(n){return m.error("Failed to clean HTML:",n),e}}htmlToMarkdown(e){try{let n=Xe(e);return this.nodeToMarkdown(n.body)}catch(n){return m.error("Failed to convert HTML to Markdown:",n),e}}nodeToMarkdown(e){if(e.nodeType===Node.TEXT_NODE)return e.textContent||"";if(e.nodeType!==Node.ELEMENT_NODE)return"";let n=e,i=n.tagName.toLowerCase(),o=Array.from(n.childNodes).map(s=>this.nodeToMarkdown(s)).join("");switch(i){case"h1":return`
# ${o}

`;case"h2":return`
## ${o}

`;case"h3":return`
### ${o}

`;case"h4":return`
#### ${o}

`;case"h5":return`
##### ${o}

`;case"h6":return`
###### ${o}

`;case"p":return`${o}

`;case"br":return`
`;case"hr":return`
---

`;case"strong":case"b":return`**${o}**`;case"em":case"i":return`*${o}*`;case"code":return`\`${o}\``;case"pre":return`
\`\`\`
${o}
\`\`\`

`;case"blockquote":return`
> ${o.replace(/\n/g,`
> `)}

`;case"ul":return`
${o}
`;case"ol":return`
${o}
`;case"li":let s=n.parentElement,d=s?.tagName.toLowerCase()==="ol",h=Array.from(s?.children||[]).indexOf(n)+1;return`${d?`${h}. `:"- "}${o}
`;case"a":{let y=n.getAttribute("href");return y?`[${o}](${y})`:o}case"img":{let y=n.getAttribute("src"),S=n.getAttribute("alt")||"";return y?`
![${S}](${y})

`:""}case"table":return`
${this.tableToMarkdown(n)}

`;default:return o}}tableToMarkdown(e){let n=Array.from(e.querySelectorAll("tr"));if(n.length===0)return"";let i=[];return n.forEach((o,s)=>{let d=Array.from(o.querySelectorAll("th, td")),h=d.map(p=>this.nodeToMarkdown(p).trim());if(i.push(`| ${h.join(" | ")} |`),s===0){let p=d.map(()=>"---").join(" | ");i.push(`| ${p} |`)}}),i.join(`
`)}extractImages(e){try{let n=Xe(e);return Array.from(n.querySelectorAll("img")).map(o=>({src:o.getAttribute("src")||"",alt:o.getAttribute("alt")||""}))}catch(n){return m.error("Failed to extract images:",n),[]}}extractLinks(e){try{let n=Xe(e);return Array.from(n.querySelectorAll("a[href]")).map(o=>({href:o.getAttribute("href")||"",text:o.textContent||""}))}catch(n){return m.error("Failed to extract links:",n),[]}}getExcerpt(e,n=200){try{let s=(Xe(e).body.textContent||"").replace(/\s+/g," ").trim();return s.length<=n?s:s.substring(0,n)+"..."}catch(i){return m.error("Failed to get excerpt:",i),""}}setEnableCleanHtml(e){this.enableCleanHtml=e}};var rn=class{plugin;app;logger;contentParser;constructor(e){this.plugin=e,this.app=e.app,this.logger=new K("NoteCreator"),this.contentParser=new nn(e.settings.enableCleanHtml)}async createNoteFromArticle(e,n){try{let{noteLocation:i,noteTemplate:o,addTags:s}=this.plugin.settings,d=this.generateNotePath(e,n,i),h=this.app.vault.getAbstractFileByPath(d);if(h instanceof ge.TFile)return this.logger.warn(`Note already exists: ${d}`),h;let p=e.content;if(!p||p.trim()===""){this.logger.info(`Fetching article content from: ${e.url}`);try{let _=await this.plugin.accountService.fetchArticleContent(e.url),{markdown:H,cleanHtml:G}=this.contentParser.parseContent(_);p=H,this.plugin.databaseService.articles.update(e.id,{content:H,contentHtml:G}),this.logger.debug(`Article content fetched and parsed: ${H.length} chars`)}catch(_){this.logger.warn("Failed to fetch article content, will create link-only note:",_),p=`[Read full article](${e.url})`}}let y={title:e.title,feedName:n.title,publishedAt:ls(e.publishedAt),url:e.url,tags:s?this.extractTags(n.title):[]},S=this.generateNoteContent({...e,content:p},y,o);await this.ensureFolderExists(d);let D=await this.app.vault.create(d,S);return this.logger.info(`Created note: ${d}`),D}catch(i){return this.logger.error(`Failed to create note for article ${e.id}:`,i),null}}async createNotesFromArticles(e,n){let i=0,o=0,s=0;for(let d of e){let h=n.get(d.feedId);if(!h){this.logger.warn(`Feed not found for article ${d.id}`),s++;continue}let p=await this.createNoteFromArticle(d,h);p?await this.findExistingNoteId(d.url)?o++:(i++,await this.updateArticleNoteId(d.id,p.path)):s++}return{created:i,skipped:o,failed:s}}generateNotePath(e,n,i){let o=sr(n.title),s=sr(e.title);return(0,ge.normalizePath)(`${i}/${o}/${s}.md`)}generateNoteContent(e,n,i){let o=i.replace(/\{\{title\}\}/g,n.title).replace(/\{\{feedName\}\}/g,n.feedName).replace(/\{\{author\}\}/g,n.author||"Unknown").replace(/\{\{publishedAt\}\}/g,n.publishedAt).replace(/\{\{url\}\}/g,n.url).replace(/\{\{date\}\}/g,new Date().toISOString().split("T")[0]).replace(/\{\{tags\}\}/g,n.tags.map(s=>`#${s}`).join(" "));return o=o.replace(/\{\{content\}\}/g,e.content),o}extractTags(e){return["wewe-rss",e.replace(/[^a-zA-Z0-9\u4e00-\u9fa5\s]/g,"").replace(/\s+/g,"-").toLowerCase()].filter(Boolean)}async ensureFolderExists(e){let n=e.substring(0,e.lastIndexOf("/"));if(!n)return;let i=this.app.vault.getAbstractFileByPath(n);if(!i)await this.app.vault.createFolder(n),this.logger.debug(`Created folder: ${n}`);else if(!(i instanceof ge.TFolder))throw new Error(`Path exists but is not a folder: ${n}`)}async findExistingNoteId(e){let n=this.app.vault.getMarkdownFiles();for(let i of n)if((await this.app.vault.read(i)).includes(e))return i.path;return null}async updateArticleNoteId(e,n){try{this.plugin.databaseService.articles.update(e,{noteId:n,synced:!0}),this.logger.debug(`Updated article ${e} with noteId: ${n}`)}catch(i){this.logger.error(`Failed to update article ${e}:`,i)}}async deleteNotesByArticleIds(e){let n=0;for(let i of e){let o=this.plugin.databaseService.articles.findById(i);o?.noteId&&await this.deleteNote(o.noteId)&&n++}return this.logger.info(`Deleted ${n} notes for ${e.length} articles`),n}async deleteNote(e){try{let n=this.app.vault.getAbstractFileByPath(e);return n instanceof ge.TFile?(await this.app.vault.delete(n),this.logger.info(`Deleted note: ${e}`),!0):!1}catch(n){return this.logger.error(`Failed to delete note ${e}:`,n),!1}}async updateNote(e,n){try{let i=this.app.vault.getAbstractFileByPath(e);return i instanceof ge.TFile?(await this.app.vault.modify(i,n),this.logger.info(`Updated note: ${e}`),!0):!1}catch(i){return this.logger.error(`Failed to update note ${e}:`,i),!1}}getNote(e){let n=this.app.vault.getAbstractFileByPath(e);return n instanceof ge.TFile?n:null}noteExists(e){return this.getNote(e)!==null}};Y();var sn=class{plugin;logger;isSyncing=!1;lastSyncTime=null;constructor(e){this.plugin=e,this.logger=new K("SyncService")}async syncAll(e={}){if(this.isSyncing)throw this.logger.warn("Sync already in progress, skipping..."),new Error("Sync already in progress");this.isSyncing=!0;let n={feedsRefreshed:0,feedsFailed:0,articlesDownloaded:0,notesCreated:0,notesSkipped:0,notesFailed:0,articlesDeleted:0,notesDeleted:0,errors:[]};try{this.logger.info("Starting sync...",e);let i=await this.refreshFeeds(e);if(n.feedsRefreshed=i.successful,n.feedsFailed=i.failed,n.articlesDownloaded=i.articlesDownloaded,n.errors.push(...i.errors),e.createNotes!==!1){let d=await this.createNotesForUnsyncedArticles();n.notesCreated=d.created,n.notesSkipped=d.skipped,n.notesFailed=d.failed}let o=this.plugin.settings.lastCleanupRetentionDays||30,s=await this.cleanupOldArticlesAndNotes(o);return n.articlesDeleted=s.articlesDeleted,n.notesDeleted=s.notesDeleted,this.lastSyncTime=new Date,this.logger.info("Sync completed successfully",n),n}catch(i){throw this.logger.error("Sync failed:",i),n.errors.push(i.message),i}finally{this.isSyncing=!1}}async refreshFeeds(e){let{staleThresholdHours:n,feedIds:i}=e,o={successful:0,failed:0,articlesDownloaded:0,errors:[]},s;i&&i.length>0?s=i.map(d=>this.plugin.databaseService.feeds.findById(d)).filter(d=>d!==null):n!==void 0?s=this.plugin.databaseService.feeds.findNeedingSync(n):s=this.plugin.databaseService.feeds.findAll(),this.logger.info(`Refreshing ${s.length} feeds...`);for(let d of s)try{let h=await this.plugin.feedService.refreshFeed(d.id);o.articlesDownloaded+=h,o.successful++,this.logger.debug(`Refreshed feed ${d.title}: ${h} new articles`)}catch(h){o.failed++;let p=`Failed to refresh feed ${d.title}: ${h.message}`;o.errors.push(p),this.logger.error(p)}return o}async createNotesForUnsyncedArticles(){let e=this.plugin.databaseService.articles.findUnsynced();if(e.length===0)return this.logger.info("No unsynced articles found"),{created:0,skipped:0,failed:0};this.logger.info(`Creating notes for ${e.length} unsynced articles...`);let n=new Map,i=[...new Set(e.map(s=>s.feedId))];for(let s of i){let d=this.plugin.databaseService.feeds.findById(s);d&&n.set(s,d)}let o=await this.plugin.noteCreator.createNotesFromArticles(e,n);return this.logger.info("Note creation completed",o),o}async cleanupOldArticlesAndNotes(e){try{this.logger.info(`Cleaning up articles older than ${e} days...`);let{deletedIds:n,count:i}=this.plugin.databaseService.articles.cleanupOldArticles(e);if(i===0)return this.logger.info("No old articles to cleanup"),{articlesDeleted:0,notesDeleted:0};let o=await this.plugin.noteCreator.deleteNotesByArticleIds(n);return this.logger.info(`Cleanup complete: ${i} articles and ${o} notes deleted`),{articlesDeleted:i,notesDeleted:o}}catch(n){return this.logger.error("Failed to cleanup old articles and notes:",n),{articlesDeleted:0,notesDeleted:0}}}async syncFeed(e){return this.syncAll({feedIds:[e],createNotes:!0})}async downloadArticlesOnly(e={}){return this.syncAll({...e,createNotes:!1})}async createNotesManually(){if(this.isSyncing)throw new Error("Sync already in progress");this.isSyncing=!0;try{return await this.createNotesForUnsyncedArticles()}finally{this.isSyncing=!1}}isRunning(){return this.isSyncing}getLastSyncTime(){return this.lastSyncTime}async getSyncStats(){let e=this.plugin.databaseService.feeds.findAll(),n=this.plugin.databaseService.articles.findAll(),i=this.plugin.databaseService.articles.findUnsynced();return{totalFeeds:e.length,totalArticles:n.length,unsyncedArticles:i.length,syncedArticles:n.length-i.length,lastSyncTime:this.lastSyncTime,isSyncing:this.isSyncing}}async cleanupOldArticles(e=30){try{let n=await this.cleanupOldArticlesAndNotes(e);return this.logger.info(`Cleaned up ${n.articlesDeleted} articles and ${n.notesDeleted} notes (retention: ${e} days)`),n}catch(n){throw this.logger.error("Failed to cleanup old articles:",n),n}}};Y();var an=class{plugin;logger;tasks=new Map;tickInterval=null;TICK_INTERVAL_MS=6e4;constructor(e){this.plugin=e,this.logger=new K("TaskScheduler")}start(){if(this.tickInterval!==null){this.logger.warn("Scheduler already running");return}this.logger.info("Starting task scheduler..."),this.tick(),this.tickInterval=window.setInterval(()=>{this.tick()},this.TICK_INTERVAL_MS),this.logger.info("Task scheduler started")}stop(){if(this.tickInterval===null){this.logger.warn("Scheduler not running");return}this.logger.info("Stopping task scheduler..."),window.clearInterval(this.tickInterval),this.tickInterval=null,this.logger.info("Task scheduler stopped")}registerTask(e,n,i){this.tasks.has(e)&&this.logger.warn(`Task ${e} already registered, updating...`);let o=new Date,s=new Date(o.getTime()+i*6e4),d={id:e,callback:n,intervalMinutes:i,lastRun:null,nextRun:s,enabled:!0};this.tasks.set(e,d),this.logger.info(`Registered task: ${e} (interval: ${i}m, next run: ${s.toISOString()})`)}unregisterTask(e){let n=this.tasks.delete(e);return n&&this.logger.info(`Unregistered task: ${e}`),n}enableTask(e){let n=this.tasks.get(e);return n?(n.enabled=!0,this.logger.info(`Enabled task: ${e}`),!0):(this.logger.warn(`Task not found: ${e}`),!1)}disableTask(e){let n=this.tasks.get(e);return n?(n.enabled=!1,this.logger.info(`Disabled task: ${e}`),!0):(this.logger.warn(`Task not found: ${e}`),!1)}updateTaskInterval(e,n){let i=this.tasks.get(e);if(!i)return this.logger.warn(`Task not found: ${e}`),!1;i.intervalMinutes=n;let o=new Date;return i.lastRun?i.nextRun=new Date(i.lastRun.getTime()+n*6e4):i.nextRun=new Date(o.getTime()+n*6e4),this.logger.info(`Updated task interval: ${e} (new interval: ${n}m, next run: ${i.nextRun.toISOString()})`),!0}async runTaskNow(e){let n=this.tasks.get(e);if(!n)throw new Error(`Task not found: ${e}`);this.logger.info(`Running task immediately: ${e}`),await this.executeTask(n)}getTaskStatus(e){return this.tasks.get(e)||null}getAllTasks(){return Array.from(this.tasks.values())}isRunning(){return this.tickInterval!==null}async tick(){let e=new Date,n=[];for(let i of this.tasks.values())i.enabled&&e>=i.nextRun&&n.push(i);if(n.length!==0){this.logger.debug(`Found ${n.length} due tasks`);for(let i of n)await this.executeTask(i)}}async executeTask(e){let n=Date.now();try{this.logger.info(`Executing task: ${e.id}`),await e.callback();let i=Date.now()-n;this.logger.info(`Task ${e.id} completed in ${i}ms`)}catch(i){this.logger.error(`Task ${e.id} failed:`,i)}finally{let i=new Date;e.lastRun=i,e.nextRun=new Date(i.getTime()+e.intervalMinutes*6e4),this.logger.debug(`Task ${e.id} next run: ${e.nextRun.toISOString()}`)}}clearAllTasks(){let e=this.tasks.size;this.tasks.clear(),this.logger.info(`Cleared ${e} tasks`)}};var on=class extends Et.Plugin{settings;databaseService;accountService;feedService;noteCreator;syncService;taskScheduler;async onload(){console.log("Loading WeWe RSS plugin"),await this.loadSettings(),this.databaseService=new Zt(this),await this.databaseService.initialize(),this.accountService=new en(this),this.feedService=new tn(this),this.noteCreator=new rn(this),this.syncService=new sn(this),this.taskScheduler=new an(this),this.taskScheduler.start(),this.settings.autoSync&&this.taskScheduler.registerTask("auto-sync",async()=>{await this.syncService.syncAll({staleThresholdHours:this.settings.syncInterval/60})},this.settings.syncInterval),this.registerView(gt,n=>new jt(n,this)),this.addRibbonIcon("rss","WeWe RSS",()=>{this.activateView()}),this.addCommand({id:"open-wewe-rss-sidebar",name:"Open WeWe RSS Sidebar",callback:()=>{this.activateView()}}),this.addCommand({id:"sync-all-feeds",name:"Sync All Feeds Now",callback:async()=>{try{let n=await this.syncService.syncAll();new Et.Notice(`Sync complete! ${n.feedsRefreshed} feeds, ${n.articlesDownloaded} articles, ${n.notesCreated} notes created`)}catch(n){new Et.Notice(`Sync failed: ${n.message}`)}}}),this.addCommand({id:"add-new-feed",name:"Add New Feed",callback:()=>{new je(this.app,this).open()}}),this.addCommand({id:"add-wechat-account",name:"Add WeChat Account",callback:()=>{new Me(this.app,this).open()}}),this.addCommand({id:"export-opml",name:"Export OPML",callback:()=>{console.log("Exporting OPML...")}}),this.addSettingTab(new Yt(this.app,this));let e=this.addStatusBarItem();e.setText("WeWe RSS: Idle"),e.addClass("wewe-rss-status-bar")}onunload(){console.log("Unloading WeWe RSS plugin"),this.taskScheduler&&this.taskScheduler.stop(),this.databaseService&&this.databaseService.close()}async loadSettings(){this.settings=Object.assign({},Xr,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async activateView(){let{workspace:e}=this.app,n=null,i=e.getLeavesOfType(gt);if(i.length>0)n=i[0];else{let o=e.getRightLeaf(!1);o&&(n=o,await n.setViewState({type:gt,active:!0}))}n&&e.revealLeaf(n)}};
